import { metricScope } from 'aws-embedded-metrics';
import { default as bunyan } from 'bunyan';
export class UnsupportedChainError extends Error {
    constructor(chainId) {
        super();
        this.chainId = chainId;
        this.name = 'UnsupportedChainError';
    }
}
export class Injector {
    constructor(injectorName) {
        this.injectorName = injectorName;
    }
    async build() {
        this.containerInjected = await this.buildContainerInjected();
        return this;
    }
    async getContainerInjected() {
        if (this.containerInjected === undefined) {
            throw new Error('Container injected undefined. Must call build() before using.');
        }
        return this.containerInjected;
    }
}
const INTERNAL_ERROR = (id) => {
    return {
        statusCode: 500,
        body: JSON.stringify({
            errorCode: 'INTERNAL_ERROR',
            detail: 'Unexpected error',
            id,
        }),
    };
};
export class APIGLambdaHandler {
    constructor(handlerName, injectorPromise) {
        this.handlerName = handlerName;
        this.injectorPromise = injectorPromise;
    }
    get handler() {
        return async (event, context) => {
            const handler = this.buildHandler();
            const response = await handler(event, context);
            return {
                ...response,
                headers: {
                    ...response.headers,
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token',
                    'Access-Control-Allow-Credentials': true,
                    'Content-Type': 'application/json',
                },
            };
        };
    }
    buildHandler() {
        return metricScope((metric) => async (event, context) => {
            const requestStart = Date.now();
            let log = bunyan.createLogger({
                name: this.handlerName,
                serializers: bunyan.stdSerializers,
                level: bunyan.INFO,
                requestId: context.awsRequestId,
            });
            log.info({ event, context }, 'Request started.');
            let requestBody;
            let requestQueryParams;
            try {
                const requestValidation = await this.parseAndValidateRequest(event, log);
                if (requestValidation.state == 'invalid') {
                    return requestValidation.errorResponse;
                }
                requestBody = requestValidation.requestBody;
                requestQueryParams = requestValidation.requestQueryParams;
            }
            catch (err) {
                log.error({ err }, 'Unexpected error validating request');
                return INTERNAL_ERROR();
            }
            const injector = await this.injectorPromise;
            const containerInjected = await injector.getContainerInjected();
            let requestInjected;
            try {
                requestInjected = await injector.getRequestInjected(containerInjected, requestBody, requestQueryParams, event, context, log, metric);
            }
            catch (err) {
                log.error({ err, event }, 'Unexpected error building request injected.');
                return INTERNAL_ERROR();
            }
            const { id } = requestInjected;
            ({ log } = requestInjected);
            let statusCode;
            let body;
            try {
                const handleRequestResult = await this.handleRequest({
                    context,
                    event,
                    requestBody,
                    requestQueryParams,
                    containerInjected,
                    requestInjected,
                });
                if (this.isError(handleRequestResult)) {
                    log.info({ handleRequestResult }, 'Handler did not return a 200');
                    const { statusCode, detail, errorCode } = handleRequestResult;
                    const response = JSON.stringify({ detail, errorCode, id });
                    log.info({ statusCode, response }, `Request ended. ${statusCode}`);
                    return {
                        statusCode,
                        body: response,
                    };
                }
                else {
                    log.info({ requestBody, requestQueryParams, requestDuration: Date.now() - requestStart }, 'Handler returned 200');
                    ({ body, statusCode } = handleRequestResult);
                }
            }
            catch (err) {
                log.error({ err }, 'Unexpected error in handler');
                return INTERNAL_ERROR(id);
            }
            let response;
            try {
                const responseValidation = await this.parseAndValidateResponse(body, id, log);
                if (responseValidation.state == 'invalid') {
                    return responseValidation.errorResponse;
                }
                response = responseValidation.response;
            }
            catch (err) {
                log.error({ err }, 'Unexpected error validating response');
                return INTERNAL_ERROR(id);
            }
            log.info({ statusCode, response }, `Request ended. ${statusCode}`);
            this.afterHandler(metric, response, requestStart);
            return {
                statusCode,
                body: JSON.stringify(response),
            };
        });
    }
    afterHandler(_, __, ___) { }
    isError(result) {
        return result.statusCode != 200 && result.statusCode != 202;
    }
    async parseAndValidateRequest(event, log) {
        let bodyRaw;
        if (event.body) {
            try {
                bodyRaw = JSON.parse(event.body);
            }
            catch (err) {
                return {
                    state: 'invalid',
                    errorResponse: {
                        statusCode: 422,
                        body: JSON.stringify({
                            detail: 'Invalid JSON body',
                            errorCode: 'VALIDATION_ERROR',
                        }),
                    },
                };
            }
        }
        let queryParamsRaw = event.queryStringParameters;
        const queryParamsSchema = this.requestQueryParamsSchema();
        let queryParams;
        if (queryParamsRaw && queryParamsSchema) {
            const queryParamsValidation = queryParamsSchema.validate(queryParamsRaw, {
                allowUnknown: true,
                stripUnknown: true,
            });
            if (queryParamsValidation.error) {
                log.info({ queryParamsValidation }, 'Request failed validation');
                return {
                    state: 'invalid',
                    errorResponse: {
                        statusCode: 400,
                        body: JSON.stringify({
                            detail: queryParamsValidation.error.message,
                            errorCode: 'VALIDATION_ERROR',
                        }),
                    },
                };
            }
            queryParams = queryParamsValidation.value;
        }
        const bodySchema = this.requestBodySchema();
        let body;
        if (bodyRaw && bodySchema) {
            const bodyValidation = bodySchema.validate(bodyRaw, {
                allowUnknown: true,
                stripUnknown: true,
            });
            if (bodyValidation.error) {
                log.info({ bodyValidation }, 'Request failed validation');
                return {
                    state: 'invalid',
                    errorResponse: {
                        statusCode: 400,
                        body: JSON.stringify({
                            detail: bodyValidation.error.message,
                            errorCode: 'VALIDATION_ERROR',
                        }),
                    },
                };
            }
            body = bodyValidation.value;
        }
        return {
            state: 'valid',
            requestBody: body,
            requestQueryParams: queryParams,
        };
    }
    async parseAndValidateResponse(body, id, log) {
        var _a, _b;
        const responseSchema = this.responseBodySchema();
        if (!responseSchema) {
            return { state: 'valid', response: body };
        }
        const res = responseSchema.validate(body, {
            allowUnknown: true,
            stripUnknown: true, // Ensure no unexpected fields returned to users.
        });
        if (res.error) {
            log.error({ error: (_a = res.error) === null || _a === void 0 ? void 0 : _a.details, errors: (_b = res.errors) === null || _b === void 0 ? void 0 : _b.details, body }, 'Unexpected error. Response failed validation.');
            return {
                state: 'invalid',
                errorResponse: INTERNAL_ERROR(id),
            };
        }
        return { state: 'valid', response: res.value };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9oYW5kbGVycy9oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxXQUFXLEVBQWlCLE1BQU0sc0JBQXNCLENBQUE7QUFPakUsT0FBTyxFQUFFLE9BQU8sSUFBSSxNQUFNLEVBQXFCLE1BQU0sUUFBUSxDQUFBO0FBOEI3RCxNQUFNLE9BQU8scUJBQXNCLFNBQVEsS0FBSztJQUM5QyxZQUFtQixPQUFlO1FBQ2hDLEtBQUssRUFBRSxDQUFBO1FBRFUsWUFBTyxHQUFQLE9BQU8sQ0FBUTtRQUczQixTQUFJLEdBQUcsdUJBQXVCLENBQUE7SUFEckMsQ0FBQztDQUVGO0FBRUQsTUFBTSxPQUFnQixRQUFRO0lBRTVCLFlBQTZCLFlBQW9CO1FBQXBCLGlCQUFZLEdBQVosWUFBWSxDQUFRO0lBQUcsQ0FBQztJQUU5QyxLQUFLLENBQUMsS0FBSztRQUNoQixJQUFJLENBQUMsaUJBQWlCLEdBQUcsTUFBTSxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQTtRQUM1RCxPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7SUFjTSxLQUFLLENBQUMsb0JBQW9CO1FBQy9CLElBQUksSUFBSSxDQUFDLGlCQUFpQixLQUFLLFNBQVMsRUFBRTtZQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLCtEQUErRCxDQUFDLENBQUE7U0FDakY7UUFDRCxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQTtJQUMvQixDQUFDO0NBQ0Y7QUFFRCxNQUFNLGNBQWMsR0FBRyxDQUFDLEVBQVcsRUFBRSxFQUFFO0lBQ3JDLE9BQU87UUFDTCxVQUFVLEVBQUUsR0FBRztRQUNmLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ25CLFNBQVMsRUFBRSxnQkFBZ0I7WUFDM0IsTUFBTSxFQUFFLGtCQUFrQjtZQUMxQixFQUFFO1NBQ0gsQ0FBQztLQUNILENBQUE7QUFDSCxDQUFDLENB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RUFBRSxJQUFJO1lBQ2xCLFlBQVksRUFBRSxJQUFJLEVBQUUsaURBQWlEO1NBQ3RFLENBQUMsQ0FBQTtRQUVGLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRTtZQUNiLEdBQUcsQ0FBQyxLQUFLLENBQ1AsRUFBRSxLQUFLLEVBQUUsTUFBQSxHQUFHLENBQUMsS0FBSywwQ0FBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQUEsR0FBRyxDQUFDLE1BQU0sMENBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxFQUNoRSwrQ0FBK0MsQ0FDaEQsQ0FBQTtZQUNELE9BQU87Z0JBQ0wsS0FBSyxFQUFFLFNBQVM7Z0JBQ2hCLGFBQWEsRUFBRSxjQUFjLENBQUMsRUFBRSxDQUFDO2FBQ2xDLENBQUE7U0FDRjtRQUVELE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxHQUFHLENBQUMsS0FBWSxFQUFFLENBQUE7SUFDdkQsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEpvaSBmcm9tICdAaGFwaS9qb2knXG5pbXBvcnQgeyBtZXRyaWNTY29wZSwgTWV0cmljc0xvZ2dlciB9IGZyb20gJ2F3cy1lbWJlZGRlZC1tZXRyaWNzJ1xuaW1wb3J0IHtcbiAgQVBJR2F0ZXdheVByb3h5RXZlbnQsXG4gIEFQSUdhdGV3YXlQcm94eUV2ZW50UXVlcnlTdHJpbmdQYXJhbWV0ZXJzLFxuICBBUElHYXRld2F5UHJveHlSZXN1bHQsXG4gIENvbnRleHQsXG59IGZyb20gJ2F3cy1sYW1iZGEnXG5pbXBvcnQgeyBkZWZhdWx0IGFzIGJ1bnlhbiwgZGVmYXVsdCBhcyBMb2dnZXIgfSBmcm9tICdidW55YW4nXG5cbmV4cG9ydCB0eXBlIEFQSUdhdGV3YXlQcm94eUhhbmRsZXIgPSAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBjb250ZXh0OiBDb250ZXh0KSA9PiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD5cblxuZXhwb3J0IHR5cGUgQmFzZVJJbmogPSB7XG4gIGxvZzogTG9nZ2VyXG4gIGlkOiBzdHJpbmdcbn1cblxuZXhwb3J0IHR5cGUgSGFuZGxlUmVxdWVzdFBhcmFtczxDSW5qLCBSSW5qLCBSZXFCb2R5LCBSZXFRdWVyeVBhcmFtcz4gPSB7XG4gIGNvbnRleHQ6IENvbnRleHRcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50XG4gIHJlcXVlc3RCb2R5OiBSZXFCb2R5XG4gIHJlcXVlc3RRdWVyeVBhcmFtczogUmVxUXVlcnlQYXJhbXNcbiAgY29udGFpbmVySW5qZWN0ZWQ6IENJbmpcbiAgcmVxdWVzdEluamVjdGVkOiBSSW5qXG59XG5cbmV4cG9ydCB0eXBlIFJlc3BvbnNlPFJlcz4gPSB7XG4gIHN0YXR1c0NvZGU6IDIwMCB8IDIwMlxuICBib2R5OiBSZXNcbiAgaGVhZGVycz86IGFueVxufVxuXG5leHBvcnQgdHlwZSBFcnJvclJlc3BvbnNlID0ge1xuICBzdGF0dXNDb2RlOiA0MDAgfCA0MDMgfCA0MDQgfCA0MDggfCA0MDkgfCA1MDBcbiAgZXJyb3JDb2RlOiBzdHJpbmdcbiAgZGV0YWlsPzogc3RyaW5nXG59XG5cbmV4cG9ydCBjbGFzcyBVbnN1cHBvcnRlZENoYWluRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBjaGFpbklkOiBudW1iZXIpIHtcbiAgICBzdXBlcigpXG4gIH1cbiAgcHVibGljIG5hbWUgPSAnVW5zdXBwb3J0ZWRDaGFpbkVycm9yJ1xufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgSW5qZWN0b3I8Q0luaiwgUkluaiBleHRlbmRzIEJhc2VSSW5qLCBSZXFCb2R5LCBSZXFRdWVyeVBhcmFtcz4ge1xuICBwcml2YXRlIGNvbnRhaW5lckluamVjdGVkOiBDSW5qXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgaW5qZWN0b3JOYW1lOiBzdHJpbmcpIHt9XG5cbiAgcHVibGljIGFzeW5jIGJ1aWxkKCkge1xuICAgIHRoaXMuY29udGFpbmVySW5qZWN0ZWQgPSBhd2FpdCB0aGlzLmJ1aWxkQ29udGFpbmVySW5qZWN0ZWQoKVxuICAgIHJldHVybiB0aGlzXG4gIH1cblxuICBwdWJsaWMgYWJzdHJhY3QgZ2V0UmVxdWVzdEluamVjdGVkKFxuICAgIGNvbnRhaW5lckluamVjdGVkOiBDSW5qLFxuICAgIHJlcXVlc3RCb2R5OiBSZXFCb2R5LFxuICAgIHJlcXVlc3RRdWVyeVBhcmFtczogUmVxUXVlcnlQYXJhbXMsXG4gICAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LFxuICAgIGNvbnRleHQ6IENvbnRleHQsXG4gICAgbG9nOiBMb2dnZXIsXG4gICAgbWV0cmljczogTWV0cmljc0xvZ2dlclxuICApOiBQcm9taXNlPFJJbmo+XG5cbiAgcHVibGljIGFic3RyYWN0IGJ1aWxkQ29udGFpbmVySW5qZWN0ZWQoKTogUHJvbWlzZTxDSW5qPlxuXG4gIHB1YmxpYyBhc3luYyBnZXRDb250YWluZXJJbmplY3RlZCgpOiBQcm9taXNlPENJbmo+IHtcbiAgICBpZiAodGhpcy5jb250YWluZXJJbmplY3RlZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvbnRhaW5lciBpbmplY3RlZCB1bmRlZmluZWQuIE11c3QgY2FsbCBidWlsZCgpIGJlZm9yZSB1c2luZy4nKVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5jb250YWluZXJJbmplY3RlZFxuICB9XG59XG5cbmNvbnN0IElOVEVSTkFMX0VSUk9SID0gKGlkPzogc3RyaW5nKSA9PiB7XG4gIHJldHVybiB7XG4gICAgc3RhdHVzQ29kZTogNTAwLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIGVycm9yQ29kZTogJ0lOVEVSTkFMX0VSUk9SJyxcbiAgICAgIGRldGFpbDogJ1VuZXhwZWN0ZWQgZXJyb3InLFxuICAgICAgaWQsXG4gICAgfSksXG4gIH1cbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEFQSUdMYW1iZGFIYW5kbGVyPENJbmosIFJJbmogZXh0ZW5kcyBCYXNlUkluaiwgUmVxQm9keSwgUmVxUXVlcnlQYXJhbXMsIFJlcz4ge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGhhbmRsZXJOYW1lOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBpbmplY3RvclByb21pc2U6IFByb21pc2U8SW5qZWN0b3I8Q0luaiwgUkluaiwgUmVxQm9keSwgUmVxUXVlcnlQYXJhbXM+PlxuICApIHt9XG5cbiAgZ2V0IGhhbmRsZXIoKTogQVBJR2F0ZXdheVByb3h5SGFuZGxlciB7XG4gICAgcmV0dXJuIGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQsIGNvbnRleHQ6IENvbnRleHQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICAgICAgY29uc3QgaGFuZGxlciA9IHRoaXMuYnVpbGRIYW5kbGVyKClcblxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBoYW5kbGVyKGV2ZW50LCBjb250ZXh0KVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5yZXNwb25zZSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIC4uLnJlc3BvbnNlLmhlYWRlcnMsXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsWC1BbXotRGF0ZSxBdXRob3JpemF0aW9uLFgtQXBpLUtleSxYLUFtei1TZWN1cml0eS1Ub2tlbicsXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUNyZWRlbnRpYWxzJzogdHJ1ZSxcbiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICB9LFxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRIYW5kbGVyKCk6IEFQSUdhdGV3YXlQcm94eUhhbmRsZXIge1xuICAgIHJldHVybiBtZXRyaWNTY29wZShcbiAgICAgIChtZXRyaWM6IE1ldHJpY3NMb2dnZXIpID0+XG4gICAgICAgIGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQsIGNvbnRleHQ6IENvbnRleHQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICAgICAgICAgIGNvbnN0IHJlcXVlc3RTdGFydCA9IERhdGUubm93KClcblxuICAgICAgICAgIGxldCBsb2c6IExvZ2dlciA9IGJ1bnlhbi5jcmVhdGVMb2dnZXIoe1xuICAgICAgICAgICAgbmFtZTogdGhpcy5oYW5kbGVyTmFtZSxcbiAgICAgICAgICAgIHNlcmlhbGl6ZXJzOiBidW55YW4uc3RkU2VyaWFsaXplcnMsXG4gICAgICAgICAgICBsZXZlbDogYnVueWFuLklORk8sXG4gICAgICAgICAgICByZXF1ZXN0SWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxuICAgICAgICAgIH0pXG5cbiAgICAgICAgICBsb2cuaW5mbyh7IGV2ZW50LCBjb250ZXh0IH0sICdSZXF1ZXN0IHN0YXJ0ZWQuJylcblxuICAgICAgICAgIGxldCByZXF1ZXN0Qm9keTogUmVxQm9keVxuICAgICAgICAgIGxldCByZXF1ZXN0UXVlcnlQYXJhbXM6IFJlcVF1ZXJ5UGFyYW1zXG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlcXVlc3RWYWxpZGF0aW9uID0gYXdhaXQgdGhpcy5wYXJzZUFuZFZhbGlkYXRlUmVxdWVzdChldmVudCwgbG9nKVxuXG4gICAgICAgICAgICBpZiAocmVxdWVzdFZhbGlkYXRpb24uc3RhdGUgPT0gJ2ludmFsaWQnKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZXF1ZXN0VmFsaWRhdGlvbi5lcnJvclJlc3BvbnNlXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlcXVlc3RCb2R5ID0gcmVxdWVzdFZhbGlkYXRpb24ucmVxdWVzdEJvZHlcbiAgICAgICAgICAgIHJlcXVlc3RRdWVyeVBhcmFtcyA9IHJlcXVlc3RWYWxpZGF0aW9uLnJlcXVlc3RRdWVyeVBhcmFtc1xuICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgbG9nLmVycm9yKHsgZXJyIH0sICdVbmV4cGVjdGVkIGVycm9yIHZhbGlkYXRpbmcgcmVxdWVzdCcpXG4gICAgICAgICAgICByZXR1cm4gSU5URVJOQUxfRVJST1IoKVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IGluamVjdG9yID0gYXdhaXQgdGhpcy5pbmplY3RvclByb21pc2VcblxuICAgICAgICAgIGNvbnN0IGNvbnRhaW5lckluamVjdGVkID0gYXdhaXQgaW5qZWN0b3IuZ2V0Q29udGFpbmVySW5qZWN0ZWQoKVxuXG4gICAgICAgICAgbGV0IHJlcXVlc3RJbmplY3RlZDogUklualxuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXF1ZXN0SW5qZWN0ZWQgPSBhd2FpdCBpbmplY3Rvci5nZXRSZXF1ZXN0SW5qZWN0ZWQoXG4gICAgICAgICAgICAgIGNvbnRhaW5lckluamVjdGVkLFxuICAgICAgICAgICAgICByZXF1ZXN0Qm9keSxcbiAgICAgICAgICAgICAgcmVxdWVzdFF1ZXJ5UGFyYW1zLFxuICAgICAgICAgICAgICBldmVudCxcbiAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgbG9nLFxuICAgICAgICAgICAgICBtZXRyaWNcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGxvZy5lcnJvcih7IGVyciwgZXZlbnQgfSwgJ1VuZXhwZWN0ZWQgZXJyb3IgYnVpbGRpbmcgcmVxdWVzdCBpbmplY3RlZC4nKVxuICAgICAgICAgICAgcmV0dXJuIElOVEVSTkFMX0VSUk9SKClcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCB7IGlkIH0gPSByZXF1ZXN0SW5qZWN0ZWRcblxuICAgICAgICAgIDsoeyBsb2cgfSA9IHJlcXVlc3RJbmplY3RlZClcblxuICAgICAgICAgIGxldCBzdGF0dXNDb2RlOiBudW1iZXJcbiAgICAgICAgICBsZXQgYm9keTogUmVzXG5cbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgaGFuZGxlUmVxdWVzdFJlc3VsdCA9IGF3YWl0IHRoaXMuaGFuZGxlUmVxdWVzdCh7XG4gICAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgICAgICByZXF1ZXN0Qm9keSxcbiAgICAgICAgICAgICAgcmVxdWVzdFF1ZXJ5UGFyYW1zLFxuICAgICAgICAgICAgICBjb250YWluZXJJbmplY3RlZCxcbiAgICAgICAgICAgICAgcmVxdWVzdEluamVjdGVkLFxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgaWYgKHRoaXMuaXNFcnJvcihoYW5kbGVSZXF1ZXN0UmVzdWx0KSkge1xuICAgICAgICAgICAgICBsb2cuaW5mbyh7IGhhbmRsZVJlcXVlc3RSZXN1bHQgfSwgJ0hhbmRsZXIgZGlkIG5vdCByZXR1cm4gYSAyMDAnKVxuICAgICAgICAgICAgICBjb25zdCB7IHN0YXR1c0NvZGUsIGRldGFpbCwgZXJyb3JDb2RlIH0gPSBoYW5kbGVSZXF1ZXN0UmVzdWx0XG4gICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gSlNPTi5zdHJpbmdpZnkoeyBkZXRhaWwsIGVycm9yQ29kZSwgaWQgfSlcblxuICAgICAgICAgICAgICBsb2cuaW5mbyh7IHN0YXR1c0NvZGUsIHJlc3BvbnNlIH0sIGBSZXF1ZXN0IGVuZGVkLiAke3N0YXR1c0NvZGV9YClcbiAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBzdGF0dXNDb2RlLFxuICAgICAgICAgICAgICAgIGJvZHk6IHJlc3BvbnNlLFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBsb2cuaW5mbyhcbiAgICAgICAgICAgICAgICB7IHJlcXVlc3RCb2R5LCByZXF1ZXN0UXVlcnlQYXJhbXMsIHJlcXVlc3REdXJhdGlvbjogRGF0ZS5ub3coKSAtIHJlcXVlc3RTdGFydCB9LFxuICAgICAgICAgICAgICAgICdIYW5kbGVyIHJldHVybmVkIDIwMCdcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICA7KHsgYm9keSwgc3RhdHVzQ29kZSB9ID0gaGFuZGxlUmVxdWVzdFJlc3VsdClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGxvZy5lcnJvcih7IGVyciB9LCAnVW5leHBlY3RlZCBlcnJvciBpbiBoYW5kbGVyJylcbiAgICAgICAgICAgIHJldHVybiBJTlRFUk5BTF9FUlJPUihpZClcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsZXQgcmVzcG9uc2U6IFJlc1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZVZhbGlkYXRpb24gPSBhd2FpdCB0aGlzLnBhcnNlQW5kVmFsaWRhdGVSZXNwb25zZShib2R5LCBpZCwgbG9nKVxuXG4gICAgICAgICAgICBpZiAocmVzcG9uc2VWYWxpZGF0aW9uLnN0YXRlID09ICdpbnZhbGlkJykge1xuICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VWYWxpZGF0aW9uLmVycm9yUmVzcG9uc2VcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVzcG9uc2UgPSByZXNwb25zZVZhbGlkYXRpb24ucmVzcG9uc2VcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGxvZy5lcnJvcih7IGVyciB9LCAnVW5leHBlY3RlZCBlcnJvciB2YWxpZGF0aW5nIHJlc3BvbnNlJylcbiAgICAgICAgICAgIHJldHVybiBJTlRFUk5BTF9FUlJPUihpZClcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsb2cuaW5mbyh7IHN0YXR1c0NvZGUsIHJlc3BvbnNlIH0sIGBSZXF1ZXN0IGVuZGVkLiAke3N0YXR1c0NvZGV9YClcblxuICAgICAgICAgIHRoaXMuYWZ0ZXJIYW5kbGVyKG1ldHJpYywgcmVzcG9uc2UsIHJlcXVlc3RTdGFydClcblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdGF0dXNDb2RlLFxuICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpLFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIClcbiAgfVxuXG4gIHByb3RlY3RlZCBhZnRlckhhbmRsZXIoXzogTWV0cmljc0xvZ2dlciwgX186IFJlcywgX19fOiBudW1iZXIpOiB2b2lkIHt9XG5cbiAgcHVibGljIGFic3RyYWN0IGhhbmRsZVJlcXVlc3QoXG4gICAgcGFyYW1zOiBIYW5kbGVSZXF1ZXN0UGFyYW1zPENJbmosIFJJbmosIFJlcUJvZHksIFJlcVF1ZXJ5UGFyYW1zPlxuICApOiBQcm9taXNlPFJlc3BvbnNlPFJlcz4gfCBFcnJvclJlc3BvbnNlPlxuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCByZXF1ZXN0Qm9keVNjaGVtYSgpOiBKb2kuT2JqZWN0U2NoZW1hIHwgbnVsbFxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgcmVxdWVzdFF1ZXJ5UGFyYW1zU2NoZW1hKCk6IEpvaS5PYmplY3RTY2hlbWEgfCBudWxsXG4gIHByb3RlY3RlZCBhYnN0cmFjdCByZXNwb25zZUJvZHlTY2hlbWEoKTogSm9pLk9iamVjdFNjaGVtYSB8IG51bGxcblxuICBwcml2YXRlIGlzRXJyb3IocmVzdWx0OiBSZXNwb25zZTxSZXM+IHwgRXJyb3JSZXNwb25zZSk6IHJlc3VsdCBpcyBFcnJvclJlc3BvbnNlIHtcbiAgICByZXR1cm4gcmVzdWx0LnN0YXR1c0NvZGUgIT0gMjAwICYmIHJlc3VsdC5zdGF0dXNDb2RlICE9IDIwMlxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBwYXJzZUFuZFZhbGlkYXRlUmVxdWVzdChcbiAgICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQsXG4gICAgbG9nOiBMb2dnZXJcbiAgKTogUHJvbWlzZTxcbiAgICB8IHtcbiAgICAgICAgc3RhdGU6ICd2YWxpZCdcbiAgICAgICAgcmVxdWVzdEJvZHk6IFJlcUJvZHlcbiAgICAgICAgcmVxdWVzdFF1ZXJ5UGFyYW1zOiBSZXFRdWVyeVBhcmFtc1xuICAgICAgfVxuICAgIHwgeyBzdGF0ZTogJ2ludmFsaWQnOyBlcnJvclJlc3BvbnNlOiBBUElHYXRld2F5UHJveHlSZXN1bHQgfVxuICA+IHtcbiAgICBsZXQgYm9keVJhdzogYW55XG5cbiAgICBpZiAoZXZlbnQuYm9keSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYm9keVJhdyA9IEpTT04ucGFyc2UoZXZlbnQuYm9keSlcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXRlOiAnaW52YWxpZCcsXG4gICAgICAgICAgZXJyb3JSZXNwb25zZToge1xuICAgICAgICAgICAgc3RhdHVzQ29kZTogNDIyLFxuICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICBkZXRhaWw6ICdJbnZhbGlkIEpTT04gYm9keScsXG4gICAgICAgICAgICAgIGVycm9yQ29kZTogJ1ZBTElEQVRJT05fRVJST1InLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGxldCBxdWVyeVBhcmFtc1JhdzogQVBJR2F0ZXdheVByb3h5RXZlbnRRdWVyeVN0cmluZ1BhcmFtZXRlcnMgfCBudWxsID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzXG4gICAgY29uc3QgcXVlcnlQYXJhbXNTY2hlbWEgPSB0aGlzLnJlcXVlc3RRdWVyeVBhcmFtc1NjaGVtYSgpXG5cbiAgICBsZXQgcXVlcnlQYXJhbXM6IFJlcVF1ZXJ5UGFyYW1zIHwgdW5kZWZpbmVkXG4gICAgaWYgKHF1ZXJ5UGFyYW1zUmF3ICYmIHF1ZXJ5UGFyYW1zU2NoZW1hKSB7XG4gICAgICBjb25zdCBxdWVyeVBhcmFtc1ZhbGlkYXRpb24gPSBxdWVyeVBhcmFtc1NjaGVtYS52YWxpZGF0ZShxdWVyeVBhcmFtc1Jhdywge1xuICAgICAgICBhbGxvd1Vua25vd246IHRydWUsIC8vIE1ha2VzIEFQSSBzY2hlbWEgY2hhbmdlcyBhbmQgcm9sbGJhY2tzIGVhc2llci5cbiAgICAgICAgc3RyaXBVbmtub3duOiB0cnVlLFxuICAgICAgfSlcblxuICAgICAgaWYgKHF1ZXJ5UGFyYW1zVmFsaWRhdGlvbi5lcnJvcikge1xuICAgICAgICBsb2cuaW5mbyh7IHF1ZXJ5UGFyYW1zVmFsaWRhdGlvbiB9LCAnUmVxdWVzdCBmYWlsZWQgdmFsaWRhdGlvbicpXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdGU6ICdpbnZhbGlkJyxcbiAgICAgICAgICBlcnJvclJlc3BvbnNlOiB7XG4gICAgICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgIGRldGFpbDogcXVlcnlQYXJhbXNWYWxpZGF0aW9uLmVycm9yLm1lc3NhZ2UsXG4gICAgICAgICAgICAgIGVycm9yQ29kZTogJ1ZBTElEQVRJT05fRVJST1InLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBxdWVyeVBhcmFtcyA9IHF1ZXJ5UGFyYW1zVmFsaWRhdGlvbi52YWx1ZSBhcyBSZXFRdWVyeVBhcmFtc1xuICAgIH1cblxuICAgIGNvbnN0IGJvZHlTY2hlbWEgPSB0aGlzLnJlcXVlc3RCb2R5U2NoZW1hKClcblxuICAgIGxldCBib2R5OiBSZXFCb2R5IHwgdW5kZWZpbmVkXG4gICAgaWYgKGJvZHlSYXcgJiYgYm9keVNjaGVtYSkge1xuICAgICAgY29uc3QgYm9keVZhbGlkYXRpb24gPSBib2R5U2NoZW1hLnZhbGlkYXRlKGJvZHlSYXcsIHtcbiAgICAgICAgYWxsb3dVbmtub3duOiB0cnVlLCAvLyBNYWtlcyBBUEkgc2NoZW1hIGNoYW5nZXMgYW5kIHJvbGxiYWNrcyBlYXNpZXIuXG4gICAgICAgIHN0cmlwVW5rbm93bjogdHJ1ZSxcbiAgICAgIH0pXG5cbiAgICAgIGlmIChib2R5VmFsaWRhdGlvbi5lcnJvcikge1xuICAgICAgICBsb2cuaW5mbyh7IGJvZHlWYWxpZGF0aW9uIH0sICdSZXF1ZXN0IGZhaWxlZCB2YWxpZGF0aW9uJylcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0ZTogJ2ludmFsaWQnLFxuICAgICAgICAgIGVycm9yUmVzcG9uc2U6IHtcbiAgICAgICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgZGV0YWlsOiBib2R5VmFsaWRhdGlvbi5lcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgICBlcnJvckNvZGU6ICdWQUxJREFUSU9OX0VSUk9SJyxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgYm9keSA9IGJvZHlWYWxpZGF0aW9uLnZhbHVlXG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXRlOiAndmFsaWQnLFxuICAgICAgcmVxdWVzdEJvZHk6IGJvZHkgYXMgUmVxQm9keSxcbiAgICAgIHJlcXVlc3RRdWVyeVBhcmFtczogcXVlcnlQYXJhbXMgYXMgUmVxUXVlcnlQYXJhbXMsXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBwYXJzZUFuZFZhbGlkYXRlUmVzcG9uc2UoXG4gICAgYm9keTogUmVzLFxuICAgIGlkOiBzdHJpbmcsXG4gICAgbG9nOiBMb2dnZXJcbiAgKTogUHJvbWlzZTx7IHN0YXRlOiAndmFsaWQnOyByZXNwb25zZTogUmVzIH0gfCB7IHN0YXRlOiAnaW52YWxpZCc7IGVycm9yUmVzcG9uc2U6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9PiB7XG4gICAgY29uc3QgcmVzcG9uc2VTY2hlbWEgPSB0aGlzLnJlc3BvbnNlQm9keVNjaGVtYSgpXG5cbiAgICBpZiAoIXJlc3BvbnNlU2NoZW1hKSB7XG4gICAgICByZXR1cm4geyBzdGF0ZTogJ3ZhbGlkJywgcmVzcG9uc2U6IGJvZHkgYXMgUmVzIH1cbiAgICB9XG5cbiAgICBjb25zdCByZXMgPSByZXNwb25zZVNjaGVtYS52YWxpZGF0ZShib2R5LCB7XG4gICAgICBhbGxvd1Vua25vd246IHRydWUsXG4gICAgICBzdHJpcFVua25vd246IHRydWUsIC8vIEVuc3VyZSBubyB1bmV4cGVjdGVkIGZpZWxkcyByZXR1cm5lZCB0byB1c2Vycy5cbiAgICB9KVxuXG4gICAgaWYgKHJlcy5lcnJvcikge1xuICAgICAgbG9nLmVycm9yKFxuICAgICAgICB7IGVycm9yOiByZXMuZXJyb3I/LmRldGFpbHMsIGVycm9yczogcmVzLmVycm9ycz8uZGV0YWlscywgYm9keSB9LFxuICAgICAgICAnVW5leHBlY3RlZCBlcnJvci4gUmVzcG9uc2UgZmFpbGVkIHZhbGlkYXRpb24uJ1xuICAgICAgKVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdGU6ICdpbnZhbGlkJyxcbiAgICAgICAgZXJyb3JSZXNwb25zZTogSU5URVJOQUxfRVJST1IoaWQpLFxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IHN0YXRlOiAndmFsaWQnLCByZXNwb25zZTogcmVzLnZhbHVlIGFzIFJlcyB9XG4gIH1cbn1cbiJdfQ==