import { Protocol } from '@uniswap/router-sdk';
import { log, } from '@uniswap/smart-order-router';
import { S3 } from 'aws-sdk';
import NodeCache from 'node-cache';
import { S3_POOL_CACHE_KEY } from '../../util/pool-cache-key';
const POOL_CACHE = new NodeCache({ stdTTL: 240, useClones: false });
const LOCAL_POOL_CACHE_KEY = (chainId, protocol) => `pools${chainId}#${protocol}`;
const s3 = new S3({ correctClockSkew: true, maxRetries: 1 });
export class AWSSubgraphProvider {
    constructor(chain, protocol, bucket, baseKey) {
        this.chain = chain;
        this.protocol = protocol;
        this.bucket = bucket;
        this.baseKey = baseKey;
    }
    async getPools() {
        log.info(`In new AWS subgraph provider for protocol ${this.protocol}`);
        const cachedPools = POOL_CACHE.get(LOCAL_POOL_CACHE_KEY(this.chain, this.protocol));
        if (cachedPools) {
            log.info({ subgraphPoolsSample: cachedPools.slice(0, 5) }, `Subgraph pools fetched from local cache for protocol ${this.protocol}. Num: ${cachedPools.length}`);
            return cachedPools;
        }
        log.info({ bucket: this.bucket, key: this.baseKey }, `Subgraph pools local cache miss for protocol ${this.protocol}. Getting subgraph pools from S3`);
        const pools = await cachePoolsFromS3(s3, this.bucket, this.baseKey, this.chain, this.protocol);
        return pools;
    }
}
export const cachePoolsFromS3 = async (s3, bucket, baseKey, chainId, protocol) => {
    const key = S3_POOL_CACHE_KEY(baseKey, chainId, protocol);
    let result;
    try {
        result = await s3.getObject({ Key: key, Bucket: bucket }).promise();
    }
    catch (err) {
        log.error({ bucket, key, err }, `Failed to get pools from S3 for ${protocol} on chain ${chainId}`);
        throw new Error(`Failed to get pools from S3 for ${protocol} on chain ${chainId}`);
    }
    const { Body: poolsBuffer } = result;
    if (!poolsBuffer) {
        throw new Error(`Could not get subgraph pool cache from S3 for protocol ${protocol} on chain ${chainId}`);
    }
    const pools = JSON.parse(poolsBuffer.toString('utf-8'));
    log.info({ bucket, key }, `Got subgraph pools from S3 for protocol ${protocol} on ${chainId}. Num: ${pools.length}`);
    POOL_CACHE.set(LOCAL_POOL_CACHE_KEY(chainId, protocol), pools);
    return pools;
};
export class V3AWSSubgraphProvider extends AWSSubgraphProvider {
    constructor(chainId, bucket, baseKey) {
        super(chainId, Protocol.V3, bucket, baseKey);
    }
    static async EagerBuild(bucket, baseKey, chainId) {
        await cachePoolsFromS3(s3, bucket, baseKey, chainId, Protocol.V3);
        return new V3AWSSubgraphProvider(chainId, bucket, baseKey);
    }
}
export class V2AWSSubgraphProvider extends AWSSubgraphProvider {
    constructor(chainId, bucket, key) {
        super(chainId, Protocol.V2, bucket, key);
    }
    static async EagerBuild(bucket, baseKey, chainId) {
        await cachePoolsFromS3(s3, bucket, baseKey, chainId, Protocol.V2);
        return new V2AWSSubgraphProvider(chainId, bucket, baseKey);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXdzLXN1YmdyYXBoLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vbGliL2hhbmRsZXJzL3JvdXRlci1lbnRpdGllcy9hd3Mtc3ViZ3JhcGgtcHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHFCQUFxQixDQUFBO0FBQzlDLE9BQU8sRUFHTCxHQUFHLEdBR0osTUFBTSw2QkFBNkIsQ0FBQTtBQUNwQyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sU0FBUyxDQUFBO0FBRTVCLE9BQU8sU0FBUyxNQUFNLFlBQVksQ0FBQTtBQUNsQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQTtBQUU3RCxNQUFNLFVBQVUsR0FBRyxJQUFJLFNBQVMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7QUFDbkUsTUFBTSxvQkFBb0IsR0FBRyxDQUFDLE9BQWdCLEVBQUUsUUFBa0IsRUFBRSxFQUFFLENBQUMsUUFBUSxPQUFPLElBQUksUUFBUSxFQUFFLENBQUE7QUFDcEcsTUFBTSxFQUFFLEdBQUcsSUFBSSxFQUFFLENBQUMsRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUE7QUFFNUQsTUFBTSxPQUFPLG1CQUFtQjtJQUM5QixZQUFvQixLQUFjLEVBQVUsUUFBa0IsRUFBVSxNQUFjLEVBQVUsT0FBZTtRQUEzRixVQUFLLEdBQUwsS0FBSyxDQUFTO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVE7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFRO0lBQUcsQ0FBQztJQUU1RyxLQUFLLENBQUMsUUFBUTtRQUNuQixHQUFHLENBQUMsSUFBSSxDQUFDLDZDQUE2QyxJQUFJLENBQUMsUUFBUSxFQUFFLENB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LGdCQUFnQixDQUFpQixFQUFFLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBRWpGLE9BQU8sSUFBSSxxQkFBcUIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFBO0lBQzVELENBQUM7Q0FDRjtBQUVELE1BQU0sT0FBTyxxQkFBc0IsU0FBUSxtQkFBbUM7SUFDNUUsWUFBWSxPQUFnQixFQUFFLE1BQWMsRUFBRSxHQUFXO1FBQ3ZELEtBQUssQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUE7SUFDMUMsQ0FBQztJQUVNLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLE1BQWMsRUFBRSxPQUFlLEVBQUUsT0FBZ0I7UUFDOUUsTUFBTSxnQkFBZ0IsQ0FBaUIsRUFBRSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUVqRixPQUFPLElBQUkscUJBQXFCLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQTtJQUM1RCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcm90b2NvbCB9IGZyb20gJ0B1bmlzd2FwL3JvdXRlci1zZGsnXG5pbXBvcnQge1xuICBJVjJTdWJncmFwaFByb3ZpZGVyLFxuICBJVjNTdWJncmFwaFByb3ZpZGVyLFxuICBsb2csXG4gIFYyU3ViZ3JhcGhQb29sLFxuICBWM1N1YmdyYXBoUG9vbCxcbn0gZnJvbSAnQHVuaXN3YXAvc21hcnQtb3JkZXItcm91dGVyJ1xuaW1wb3J0IHsgUzMgfSBmcm9tICdhd3Mtc2RrJ1xuaW1wb3J0IHsgQ2hhaW5JZCB9IGZyb20gJ0B1bmlzd2FwL3Nkay1jb3JlJ1xuaW1wb3J0IE5vZGVDYWNoZSBmcm9tICdub2RlLWNhY2hlJ1xuaW1wb3J0IHsgUzNfUE9PTF9DQUNIRV9LRVkgfSBmcm9tICcuLi8uLi91dGlsL3Bvb2wtY2FjaGUta2V5J1xuXG5jb25zdCBQT09MX0NBQ0hFID0gbmV3IE5vZGVDYWNoZSh7IHN0ZFRUTDogMjQwLCB1c2VDbG9uZXM6IGZhbHNlIH0pXG5jb25zdCBMT0NBTF9QT09MX0NBQ0hFX0tFWSA9IChjaGFpbklkOiBDaGFpbklkLCBwcm90b2NvbDogUHJvdG9jb2wpID0+IGBwb29scyR7Y2hhaW5JZH0jJHtwcm90b2NvbH1gXG5jb25zdCBzMyA9IG5ldyBTMyh7IGNvcnJlY3RDbG9ja1NrZXc6IHRydWUsIG1heFJldHJpZXM6IDEgfSlcblxuZXhwb3J0IGNsYXNzIEFXU1N1YmdyYXBoUHJvdmlkZXI8VFN1YmdyYXBoUG9vbCBleHRlbmRzIFYyU3ViZ3JhcGhQb29sIHwgVjNTdWJncmFwaFBvb2w+IHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjaGFpbjogQ2hhaW5JZCwgcHJpdmF0ZSBwcm90b2NvbDogUHJvdG9jb2wsIHByaXZhdGUgYnVja2V0OiBzdHJpbmcsIHByaXZhdGUgYmFzZUtleTogc3RyaW5nKSB7fVxuXG4gIHB1YmxpYyBhc3luYyBnZXRQb29scygpOiBQcm9taXNlPFRTdWJncmFwaFBvb2xbXT4ge1xuICAgIGxvZy5pbmZvKGBJbiBuZXcgQVdTIHN1YmdyYXBoIHByb3ZpZGVyIGZvciBwcm90b2NvbCAke3RoaXMucHJvdG9jb2x9YClcblxuICAgIGNvbnN0IGNhY2hlZFBvb2xzID0gUE9PTF9DQUNIRS5nZXQ8VFN1YmdyYXBoUG9vbFtdPihMT0NBTF9QT09MX0NBQ0hFX0tFWSh0aGlzLmNoYWluLCB0aGlzLnByb3RvY29sKSlcblxuICAgIGlmIChjYWNoZWRQb29scykge1xuICAgICAgbG9nLmluZm8oXG4gICAgICAgIHsgc3ViZ3JhcGhQb29sc1NhbXBsZTogY2FjaGVkUG9vbHMuc2xpY2UoMCwgNSkgfSxcbiAgICAgICAgYFN1YmdyYXBoIHBvb2xzIGZldGNoZWQgZnJvbSBsb2NhbCBjYWNoZSBmb3IgcHJvdG9jb2wgJHt0aGlzLnByb3RvY29sfS4gTnVtOiAke2NhY2hlZFBvb2xzLmxlbmd0aH1gXG4gICAgICApXG5cbiAgICAgIHJldHVybiBjYWNoZWRQb29sc1xuICAgIH1cblxuICAgIGxvZy5pbmZvKFxuICAgICAgeyBidWNrZXQ6IHRoaXMuYnVja2V0LCBrZXk6IHRoaXMuYmFzZUtleSB9LFxuICAgICAgYFN1YmdyYXBoIHBvb2xzIGxvY2FsIGNhY2hlIG1pc3MgZm9yIHByb3RvY29sICR7dGhpcy5wcm90b2NvbH0uIEdldHRpbmcgc3ViZ3JhcGggcG9vbHMgZnJvbSBTM2BcbiAgICApXG5cbiAgICBjb25zdCBwb29scyA9IGF3YWl0IGNhY2hlUG9vbHNGcm9tUzM8VFN1YmdyYXBoUG9vbD4oczMsIHRoaXMuYnVja2V0LCB0aGlzLmJhc2VLZXksIHRoaXMuY2hhaW4sIHRoaXMucHJvdG9jb2wpXG5cbiAgICByZXR1cm4gcG9vbHNcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgY2FjaGVQb29sc0Zyb21TMyA9IGFzeW5jIDxUU3ViZ3JhcGhQb29sPihcbiAgczM6IFMzLFxuICBidWNrZXQ6IHN0cmluZyxcbiAgYmFzZUtleTogc3RyaW5nLFxuICBjaGFpbklkOiBDaGFpbklkLFxuICBwcm90b2NvbDogUHJvdG9jb2xcbikgPT4ge1xuICBjb25zdCBrZXkgPSBTM19QT09MX0NBQ0hFX0tFWShiYXNlS2V5LCBjaGFpbklkLCBwcm90b2NvbClcblxuICBsZXQgcmVzdWx0XG4gIHRyeSB7XG4gICAgcmVzdWx0ID0gYXdhaXQgczMuZ2V0T2JqZWN0KHsgS2V5OiBrZXksIEJ1Y2tldDogYnVja2V0IH0pLnByb21pc2UoKVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZXJyb3IoeyBidWNrZXQsIGtleSwgZXJyIH0sIGBGYWlsZWQgdG8gZ2V0IHBvb2xzIGZyb20gUzMgZm9yICR7cHJvdG9jb2x9IG9uIGNoYWluICR7Y2hhaW5JZH1gKVxuICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGdldCBwb29scyBmcm9tIFMzIGZvciAke3Byb3RvY29sfSBvbiBjaGFpbiAke2NoYWluSWR9YClcbiAgfVxuXG4gIGNvbnN0IHsgQm9keTogcG9vbHNCdWZmZXIgfSA9IHJlc3VsdFxuXG4gIGlmICghcG9vbHNCdWZmZXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBnZXQgc3ViZ3JhcGggcG9vbCBjYWNoZSBmcm9tIFMzIGZvciBwcm90b2NvbCAke3Byb3RvY29sfSBvbiBjaGFpbiAke2NoYWluSWR9YClcbiAgfVxuXG4gIGNvbnN0IHBvb2xzID0gSlNPTi5wYXJzZShwb29sc0J1ZmZlci50b1N0cmluZygndXRmLTgnKSkgYXMgVFN1YmdyYXBoUG9vbFtdXG5cbiAgbG9nLmluZm8oeyBidWNrZXQsIGtleSB9LCBgR290IHN1YmdyYXBoIHBvb2xzIGZyb20gUzMgZm9yIHByb3RvY29sICR7cHJvdG9jb2x9IG9uICR7Y2hhaW5JZH0uIE51bTogJHtwb29scy5sZW5ndGh9YClcblxuICBQT09MX0NBQ0hFLnNldDxUU3ViZ3JhcGhQb29sW10+KExPQ0FMX1BPT0xfQ0FDSEVfS0VZKGNoYWluSWQsIHByb3RvY29sKSwgcG9vbHMpXG5cbiAgcmV0dXJuIHBvb2xzXG59XG5cbmV4cG9ydCBjbGFzcyBWM0FXU1N1YmdyYXBoUHJvdmlkZXIgZXh0ZW5kcyBBV1NTdWJncmFwaFByb3ZpZGVyPFYzU3ViZ3JhcGhQb29sPiBpbXBsZW1lbnRzIElWM1N1YmdyYXBoUHJvdmlkZXIge1xuICBjb25zdHJ1Y3RvcihjaGFpbklkOiBDaGFpbklkLCBidWNrZXQ6IHN0cmluZywgYmFzZUtleTogc3RyaW5nKSB7XG4gICAgc3VwZXIoY2hhaW5JZCwgUHJvdG9jb2wuVjMsIGJ1Y2tldCwgYmFzZUtleSlcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgYXN5bmMgRWFnZXJCdWlsZChidWNrZXQ6IHN0cmluZywgYmFzZUtleTogc3RyaW5nLCBjaGFpbklkOiBDaGFpbklkKTogUHJvbWlzZTxWM0FXU1N1YmdyYXBoUHJvdmlkZXI+IHtcbiAgICBhd2FpdCBjYWNoZVBvb2xzRnJvbVMzPFYzU3ViZ3JhcGhQb29sPihzMywgYnVja2V0LCBiYXNlS2V5LCBjaGFpbklkLCBQcm90b2NvbC5WMylcblxuICAgIHJldHVybiBuZXcgVjNBV1NTdWJncmFwaFByb3ZpZGVyKGNoYWluSWQsIGJ1Y2tldCwgYmFzZUtleSlcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVjJBV1NTdWJncmFwaFByb3ZpZGVyIGV4dGVuZHMgQVdTU3ViZ3JhcGhQcm92aWRlcjxWMlN1YmdyYXBoUG9vbD4gaW1wbGVtZW50cyBJVjJTdWJncmFwaFByb3ZpZGVyIHtcbiAgY29uc3RydWN0b3IoY2hhaW5JZDogQ2hhaW5JZCwgYnVja2V0OiBzdHJpbmcsIGtleTogc3RyaW5nKSB7XG4gICAgc3VwZXIoY2hhaW5JZCwgUHJvdG9jb2wuVjIsIGJ1Y2tldCwga2V5KVxuICB9XG5cbiAgcHVibGljIHN0YXRpYyBhc3luYyBFYWdlckJ1aWxkKGJ1Y2tldDogc3RyaW5nLCBiYXNlS2V5OiBzdHJpbmcsIGNoYWluSWQ6IENoYWluSWQpOiBQcm9taXNlPFYyQVdTU3ViZ3JhcGhQcm92aWRlcj4ge1xuICAgIGF3YWl0IGNhY2hlUG9vbHNGcm9tUzM8VjJTdWJncmFwaFBvb2w+KHMzLCBidWNrZXQsIGJhc2VLZXksIGNoYWluSWQsIFByb3RvY29sLlYyKVxuXG4gICAgcmV0dXJuIG5ldyBWMkFXU1N1YmdyYXBoUHJvdmlkZXIoY2hhaW5JZCwgYnVja2V0LCBiYXNlS2V5KVxuICB9XG59XG4iXX0=