import pinataSDK from '@pinata/sdk';
import { ID_TO_NETWORK_NAME } from '@uniswap/smart-order-router';
import { Route53, STS } from 'aws-sdk';
import { default as bunyan } from 'bunyan';
import fs from 'fs';
import _ from 'lodash';
import path from 'path';
import { chainProtocols } from './cache-config';
const PARENT = '/tmp/temp/';
const DIRECTORY = '/tmp/temp/v1/pools/';
const pinata = pinataSDK(process.env.PINATA_API_KEY, process.env.PINATA_API_SECRET);
const handler = async (event) => {
    var _a, _b, _c;
    const log = bunyan.createLogger({
        name: 'IPFSPoolCacheLambda',
        serializers: bunyan.stdSerializers,
        level: 'info',
        requestId: event.id,
    });
    const sts = new STS();
    const stsParams = {
        RoleArn: process.env.ROLE_ARN,
        RoleSessionName: `UpdateApiRoute53Role`,
    };
    // init route53 with credentials
    let data;
    let route53;
    try {
        data = await sts.assumeRole(stsParams).promise();
    }
    catch (err) {
        log.error({ err }, `Error assuming role`);
        throw err;
    }
    log.info(`Role assumed`);
    try {
        const accessKeyId = (_a = data === null || data === void 0 ? void 0 : data.Credentials) === null || _a === void 0 ? void 0 : _a.AccessKeyId;
        const secretAccess = (_b = data === null || data === void 0 ? void 0 : data.Credentials) === null || _b === void 0 ? void 0 : _b.SecretAccessKey;
        const sessionKey = (_c = data === null || data === void 0 ? void 0 : data.Credentials) === null || _c === void 0 ? void 0 : _c.SessionToken;
        route53 = new Route53({
            credentials: {
                accessKeyId: accessKeyId,
                secretAccessKey: secretAccess,
                sessionToken: sessionKey,
            },
        });
    }
    catch (err) {
        log.error({ err }, 'Route53 not initialized with correct credentials');
        throw err;
    }
    await Promise.all(_.map(chainProtocols, async ({ protocol, chainId, provider }) => {
        const ipfsFilename = `${ID_TO_NETWORK_NAME(chainId)}.json`;
        log.info(`Getting ${protocol} pools for chain ${chainId}`);
        const pools = await provider.getPools();
        log.info(`Got ${pools.length} ${protocol} pools for chain ${chainId}. Will save with filename ${ipfsFilename}`);
        const poolString = JSON.stringify(pools);
        // create directory and file for the chain and protocol
        // e.g: /tmp/temp/v1/pools/v3/mainnet.json
        const parentDirectory = path.join(DIRECTORY, protocol.toLowerCase());
        const fullPath = path.join(DIRECTORY, protocol.toLowerCase(), ipfsFilename);
        fs.mkdirSync(parentDirectory, { recursive: true });
        fs.writeFileSync(fullPath, poolString);
    }));
    // pins everything under '/tmp/` which should include mainnet.txt and rinkeby.txt
    // only have to pin once for all chains
    let result;
    let hash;
    try {
        log.info({ result }, `Pinning to pinata: ${PARENT}`);
        result = await pinata.pinFromFS(PARENT);
        const url = `https://ipfs.io/ipfs/${result.IpfsHash}`;
        hash = result.IpfsHash;
        log.info({ result }, `Successful pinning. IPFS hash: ${hash} and url : ${url}`);
    }
    catch (err) {
        log.error({ err }, 'Error pinning');
        throw err;
    }
    // link resulting hash to DNS
    const domain = process.env.STAGE == 'prod' ? 'api.uniswap.org' : 'beta.api.uniswap.org';
    var params = {
        ChangeBatch: {
            Changes: [
                {
                    Action: 'UPSERT',
                    ResourceRecordSet: {
                        Name: domain,
                        ResourceRecords: [
                            {
                                Value: `\"dnslink=/ipfs/${hash}\"`,
                            },
                        ],
                        TTL: 60,
                        Type: 'TXT',
                    },
                },
            ],
        },
        HostedZoneId: process.env.HOSTED_ZONE,
    };
    try {
        log.info({ params }, `Updating record set`);
        const data = await route53.changeResourceRecordSets(params).promise();
        log.info(`Successful record update: ${data}`);
    }
    catch (err) {
        log.error({ err }, 'Error updating DNS');
        throw err;
    }
};
module.exports = { handler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtcG9vbHMtaXBmcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jcm9uL2NhY2hlLXBvb2xzLWlwZnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxTQUFTLE1BQU0sYUFBYSxDQUFBO0FBQ25DLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDZCQUE2QixDQUFBO0FBRWhFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sU0FBUyxDQUFBO0FBQ3RDLE9BQU8sRUFBRSxPQUFPLElBQUksTUFBTSxFQUFxQixNQUFNLFFBQVEsQ0FBQTtBQUM3RCxPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUE7QUFDbkIsT0FBTyxDQUFDLE1BQU0sUUFBUSxDQUFBO0FBQ3RCLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQTtBQUN2QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFFL0MsTUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFBO0FBRTNCLE1BQU0sU0FBUyxHQUFHLHFCQUFxQixDQUFBO0FBRXZDLE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFrQixDQUFDLENBQUE7QUFFckYsTUFBTSxPQUFPLEdBQXFCLEtBQUssRUFBRSxLQUFxQyxFQUFFLEVBQUU7O0lBQ2hGLE1BQU0sR0FBRyxHQUFXLE1BQU0sQ0FBQyxZQUFZLENBQUM7UUFDdEMsSUFBSSxFQUFFLHFCQUFxQjtRQUMzQixXQUFXLEVBQUUsTUFBTSxDQUFDLGNBQWM7UUFDbEMsS0FBSyxFQUFFLE1BQU07UUFDYixTQUFTLEVBQUUsS0FBSyxDQUFDLEVBQUU7S0FDcEIsQ0FBQyxDQUFBO0lBRUYsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtJQUNyQixNQUFNLFNBQVMsR0FBRztRQUNoQixPQUFPLEVBQUUsT0FB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LDZCQUE2QixJQUFJLEVBQUUsQ0FBQyxDQUFBO0tBQzlDO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDWixHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsb0JBQW9CLENBQUMsQ0FBQTtRQUN4QyxNQUFNLEdBQUcsQ0FBQTtLQUNWO0FBQ0gsQ0FBQyxDQUFBO0FBQ0QsTUFBTSxDQUFDLE9BQU8sR0FBRyxFQUFFLE9BQU8sRUFBRSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBpbmF0YVNESyBmcm9tICdAcGluYXRhL3NkaydcbmltcG9ydCB7IElEX1RPX05FVFdPUktfTkFNRSB9IGZyb20gJ0B1bmlzd2FwL3NtYXJ0LW9yZGVyLXJvdXRlcidcbmltcG9ydCB7IEV2ZW50QnJpZGdlRXZlbnQsIFNjaGVkdWxlZEhhbmRsZXIgfSBmcm9tICdhd3MtbGFtYmRhJ1xuaW1wb3J0IHsgUm91dGU1MywgU1RTIH0gZnJvbSAnYXdzLXNkaydcbmltcG9ydCB7IGRlZmF1bHQgYXMgYnVueWFuLCBkZWZhdWx0IGFzIExvZ2dlciB9IGZyb20gJ2J1bnlhbidcbmltcG9ydCBmcyBmcm9tICdmcydcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCdcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgeyBjaGFpblByb3RvY29scyB9IGZyb20gJy4vY2FjaGUtY29uZmlnJ1xuXG5jb25zdCBQQVJFTlQgPSAnL3RtcC90ZW1wLydcblxuY29uc3QgRElSRUNUT1JZID0gJy90bXAvdGVtcC92MS9wb29scy8nXG5cbmNvbnN0IHBpbmF0YSA9IHBpbmF0YVNESyhwcm9jZXNzLmVudi5QSU5BVEFfQVBJX0tFWSEsIHByb2Nlc3MuZW52LlBJTkFUQV9BUElfU0VDUkVUISlcblxuY29uc3QgaGFuZGxlcjogU2NoZWR1bGVkSGFuZGxlciA9IGFzeW5jIChldmVudDogRXZlbnRCcmlkZ2VFdmVudDxzdHJpbmcsIHZvaWQ+KSA9PiB7XG4gIGNvbnN0IGxvZzogTG9nZ2VyID0gYnVueWFuLmNyZWF0ZUxvZ2dlcih7XG4gICAgbmFtZTogJ0lQRlNQb29sQ2FjaGVMYW1iZGEnLFxuICAgIHNlcmlhbGl6ZXJzOiBidW55YW4uc3RkU2VyaWFsaXplcnMsXG4gICAgbGV2ZWw6ICdpbmZvJyxcbiAgICByZXF1ZXN0SWQ6IGV2ZW50LmlkLFxuICB9KVxuXG4gIGNvbnN0IHN0cyA9IG5ldyBTVFMoKVxuICBjb25zdCBzdHNQYXJhbXMgPSB7XG4gICAgUm9sZUFybjogcHJvY2Vzcy5lbnYuUk9MRV9BUk4hLFxuICAgIFJvbGVTZXNzaW9uTmFtZTogYFVwZGF0ZUFwaVJvdXRlNTNSb2xlYCxcbiAgfVxuXG4gIC8vIGluaXQgcm91dGU1MyB3aXRoIGNyZWRlbnRpYWxzXG4gIGxldCBkYXRhXG4gIGxldCByb3V0ZTUzXG4gIHRyeSB7XG4gICAgZGF0YSA9IGF3YWl0IHN0cy5hc3N1bWVSb2xlKHN0c1BhcmFtcykucHJvbWlzZSgpXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvcih7IGVyciB9LCBgRXJyb3IgYXNzdW1pbmcgcm9sZWApXG4gICAgdGhyb3cgZXJyXG4gIH1cblxuICBsb2cuaW5mbyhgUm9sZSBhc3N1bWVkYClcbiAgdHJ5IHtcbiAgICBjb25zdCBhY2Nlc3NLZXlJZCA9IGRhdGE/LkNyZWRlbnRpYWxzPy5BY2Nlc3NLZXlJZFxuICAgIGNvbnN0IHNlY3JldEFjY2VzcyA9IGRhdGE/LkNyZWRlbnRpYWxzPy5TZWNyZXRBY2Nlc3NLZXlcbiAgICBjb25zdCBzZXNzaW9uS2V5ID0gZGF0YT8uQ3JlZGVudGlhbHM/LlNlc3Npb25Ub2tlblxuICAgIHJvdXRlNTMgPSBuZXcgUm91dGU1Myh7XG4gICAgICBjcmVkZW50aWFsczoge1xuICAgICAgICBhY2Nlc3NLZXlJZDogYWNjZXNzS2V5SWQhLFxuICAgICAgICBzZWNyZXRBY2Nlc3NLZXk6IHNlY3JldEFjY2VzcyEsXG4gICAgICAgIHNlc3Npb25Ub2tlbjogc2Vzc2lvbktleSxcbiAgICAgIH0sXG4gICAgfSlcbiAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICBsb2cuZXJyb3IoeyBlcnIgfSwgJ1JvdXRlNTMgbm90IGluaXRpYWxpemVkIHdpdGggY29ycmVjdCBjcmVkZW50aWFscycpXG4gICAgdGhyb3cgZXJyXG4gIH1cblxuICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICBfLm1hcChjaGFpblByb3RvY29scywgYXN5bmMgKHsgcHJvdG9jb2wsIGNoYWluSWQsIHByb3ZpZGVyIH0pID0+IHtcbiAgICAgIGNvbnN0IGlwZnNGaWxlbmFtZSA9IGAke0lEX1RPX05FVFdPUktfTkFNRShjaGFpbklkKX0uanNvbmBcbiAgICAgIGxvZy5pbmZvKGBHZXR0aW5nICR7cHJvdG9jb2x9IHBvb2xzIGZvciBjaGFpbiAke2NoYWluSWR9YClcbiAgICAgIGNvbnN0IHBvb2xzID0gYXdhaXQgcHJvdmlkZXIuZ2V0UG9vbHMoKVxuICAgICAgbG9nLmluZm8oYEdvdCAke3Bvb2xzLmxlbmd0aH0gJHtwcm90b2NvbH0gcG9vbHMgZm9yIGNoYWluICR7Y2hhaW5JZH0uIFdpbGwgc2F2ZSB3aXRoIGZpbGVuYW1lICR7aXBmc0ZpbGVuYW1lfWApXG4gICAgICBjb25zdCBwb29sU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkocG9vbHMpXG5cbiAgICAgIC8vIGNyZWF0ZSBkaXJlY3RvcnkgYW5kIGZpbGUgZm9yIHRoZSBjaGFpbiBhbmQgcHJvdG9jb2xcbiAgICAgIC8vIGUuZzogL3RtcC90ZW1wL3YxL3Bvb2xzL3YzL21haW5uZXQuanNvblxuICAgICAgY29uc3QgcGFyZW50RGlyZWN0b3J5ID0gcGF0aC5qb2luKERJUkVDVE9SWSwgcHJvdG9jb2wudG9Mb3dlckNhc2UoKSlcbiAgICAgIGNvbnN0IGZ1bGxQYXRoID0gcGF0aC5qb2luKERJUkVDVE9SWSwgcHJvdG9jb2wudG9Mb3dlckNhc2UoKSwgaXBmc0ZpbGVuYW1lKVxuICAgICAgZnMubWtkaXJTeW5jKHBhcmVudERpcmVjdG9yeSwgeyByZWN1cnNpdmU6IHRydWUgfSlcbiAgICAgIGZzLndyaXRlRmlsZVN5bmMoZnVsbFBhdGgsIHBvb2xTdHJpbmcpXG4gICAgfSlcbiAgKVxuXG4gIC8vIHBpbnMgZXZlcnl0aGluZyB1bmRlciAnL3RtcC9gIHdoaWNoIHNob3VsZCBpbmNsdWRlIG1haW5uZXQudHh0IGFuZCByaW5rZWJ5LnR4dFxuICAvLyBvbmx5IGhhdmUgdG8gcGluIG9uY2UgZm9yIGFsbCBjaGFpbnNcbiAgbGV0IHJlc3VsdFxuICBsZXQgaGFzaFxuICB0cnkge1xuICAgIGxvZy5pbmZvKHsgcmVzdWx0IH0sIGBQaW5uaW5nIHRvIHBpbmF0YTogJHtQQVJFTlR9YClcbiAgICByZXN1bHQgPSBhd2FpdCBwaW5hdGEucGluRnJvbUZTKFBBUkVOVClcbiAgICBjb25zdCB1cmwgPSBgaHR0cHM6Ly9pcGZzLmlvL2lwZnMvJHtyZXN1bHQuSXBmc0hhc2h9YFxuICAgIGhhc2ggPSByZXN1bHQuSXBmc0hhc2hcblxuICAgIGxvZy5pbmZvKHsgcmVzdWx0IH0sIGBTdWNjZXNzZnVsIHBpbm5pbmcuIElQRlMgaGFzaDogJHtoYXNofSBhbmQgdXJsIDogJHt1cmx9YClcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yKHsgZXJyIH0sICdFcnJvciBwaW5uaW5nJylcbiAgICB0aHJvdyBlcnJcbiAgfVxuXG4gIC8vIGxpbmsgcmVzdWx0aW5nIGhhc2ggdG8gRE5TXG4gIGNvbnN0IGRvbWFpbiA9IHByb2Nlc3MuZW52LlNUQUdFID09ICdwcm9kJyA/ICdhcGkudW5pc3dhcC5vcmcnIDogJ2JldGEuYXBpLnVuaXN3YXAub3JnJ1xuICB2YXIgcGFyYW1zID0ge1xuICAgIENoYW5nZUJhdGNoOiB7XG4gICAgICBDaGFuZ2VzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBBY3Rpb246ICdVUFNFUlQnLFxuICAgICAgICAgIFJlc291cmNlUmVjb3JkU2V0OiB7XG4gICAgICAgICAgICBOYW1lOiBkb21haW4sXG4gICAgICAgICAgICBSZXNvdXJjZVJlY29yZHM6IFtcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIFZhbHVlOiBgXFxcImRuc2xpbms9L2lwZnMvJHtoYXNofVxcXCJgLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIFRUTDogNjAsXG4gICAgICAgICAgICBUeXBlOiAnVFhUJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9LFxuICAgIEhvc3RlZFpvbmVJZDogcHJvY2Vzcy5lbnYuSE9TVEVEX1pPTkUhLFxuICB9XG4gIHRyeSB7XG4gICAgbG9nLmluZm8oeyBwYXJhbXMgfSwgYFVwZGF0aW5nIHJlY29yZCBzZXRgKVxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByb3V0ZTUzLmNoYW5nZVJlc291cmNlUmVjb3JkU2V0cyhwYXJhbXMpLnByb21pc2UoKVxuICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsIHJlY29yZCB1cGRhdGU6ICR7ZGF0YX1gKVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZXJyb3IoeyBlcnIgfSwgJ0Vycm9yIHVwZGF0aW5nIEROUycpXG4gICAgdGhyb3cgZXJyXG4gIH1cbn1cbm1vZHVsZS5leHBvcnRzID0geyBoYW5kbGVyIH1cbiJdfQ==