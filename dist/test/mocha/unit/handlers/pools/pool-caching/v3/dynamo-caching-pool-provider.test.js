import { setupTables } from '../../../../../dbSetup';
import { DynamoDBCachingV3PoolProvider } from '../../../../../../../lib/handlers/pools/pool-caching/v3/dynamo-caching-pool-provider';
import { getMockedV3PoolProvider, TEST_ROUTE_TABLE } from '../../../../../../test-utils/mocked-dependencies';
import { SUPPORTED_POOLS } from '../../../../../../test-utils/mocked-data';
import { ChainId } from '@uniswap/sdk-core';
import { expect } from 'chai';
import { DynamoCachingV3Pool } from '../../../../../../../lib/handlers/pools/pool-caching/v3/cache-dynamo-pool';
import { log } from '@uniswap/smart-order-router';
describe('DynamoDBCachingV3PoolProvider', async () => {
    setupTables(TEST_ROUTE_TABLE);
    it('caches pools properly with a given block number', async () => {
        const dynamoPoolCache = new DynamoDBCachingV3PoolProvider(ChainId.GOERLI, getMockedV3PoolProvider(), TEST_ROUTE_TABLE.TableName);
        const dynamoCache = new DynamoCachingV3Pool({ tableName: TEST_ROUTE_TABLE.TableName });
        const providerConfig = { blockNumber: 111 };
        const blockNumber = await providerConfig.blockNumber;
        // First ensure the dynamo cache doesn't have the pools yet
        for (const pool of SUPPORTED_POOLS) {
            const poolAddress = getMockedV3PoolProvider().getPoolAddress(pool.token0, pool.token1, pool.fee).poolAddress;
            const hasCachedPool = await dynamoCache.get(`pool-${ChainId.GOERLI}-${poolAddress}`, blockNumber);
            expect(hasCachedPool).to.not.exist;
        }
        const tokenPairs = SUPPORTED_POOLS.map((pool) => {
            return [pool.token0, pool.token1, pool.fee];
        });
        await dynamoPoolCache.getPools(tokenPairs, providerConfig);
        // Then ensure the dynamo cache has the pools yet
        for (const pool of SUPPORTED_POOLS) {
            const poolAddress = getMockedV3PoolProvider().getPoolAddress(pool.token0, pool.token1, pool.fee).poolAddress;
            const hasCachedPool = await dynamoCache.get(`pool-${ChainId.GOERLI}-${poolAddress}`, blockNumber);
            expect(hasCachedPool).to.exist;
            expect(hasCachedPool === null || hasCachedPool === void 0 ? void 0 : hasCachedPool.token0.chainId).equals(pool.token0.chainId);
            expect(hasCachedPool === null || hasCachedPool === void 0 ? void 0 : hasCachedPool.token0.decimals).equals(pool.token0.decimals);
            expect(hasCachedPool === null || hasCachedPool === void 0 ? void 0 : hasCachedPool.token0.address).equals(pool.token0.address);
            expect(hasCachedPool === null || hasCachedPool === void 0 ? void 0 : hasCachedPool.token1.chainId).equals(pool.token1.chainId);
            expect(hasCachedPool === null || hasCachedPool === void 0 ? void 0 : hasCachedPool.token1.decimals).equals(pool.token1.decimals);
            expect(hasCachedPool === null || hasCachedPool === void 0 ? void 0 : hasCachedPool.token1.address).equals(pool.token1.address);
            expect(hasCachedPool === null || hasCachedPool === void 0 ? void 0 : hasCachedPool.fee).equals(pool.fee);
            expect(hasCachedPool === null || hasCachedPool === void 0 ? void 0 : hasCachedPool.sqrtRatioX96.toString()).equals(pool.sqrtRatioX96.toString());
            expect(hasCachedPool === null || hasCachedPool === void 0 ? void 0 : hasCachedPool.liquidity.toString()).equals(pool.liquidity.toString());
            expect(hasCachedPool === null || hasCachedPool === void 0 ? void 0 : hasCachedPool.tickCurrent).equals(pool.tickCurrent);
        }
    });
    it('caches do not cache when no block number', async () => {
        const dynamoPoolCache = new DynamoDBCachingV3PoolProvider(ChainId.GOERLI, getMockedV3PoolProvider(), TEST_ROUTE_TABLE.TableName);
        const dynamoCache = new DynamoCachingV3Pool({ tableName: TEST_ROUTE_TABLE.TableName });
        const providerConfig = { blockNumber: undefined };
        const blockNumber = await providerConfig.blockNumber;
        // First ensure the dynamo cache doesn't have the pools yet
        for (const pool of SUPPORTED_POOLS) {
            const poolAddress = getMockedV3PoolProvider().getPoolAddress(pool.token0, pool.token1, pool.fee).poolAddress;
            log.info(`check if pool pool-${ChainId.GOERLI}-${poolAddress} block ${blockNumber} contains the cache`);
            const hasCachedPool = await dynamoCache.get(`pool-${ChainId.GOERLI}-${poolAddress}`, blockNumber);
            expect(hasCachedPool).to.not.exist;
        }
        const tokenPairs = SUPPORTED_POOLS.map((pool) => {
            return [pool.token0, pool.token1, pool.fee];
        });
        await dynamoPoolCache.getPools(tokenPairs, providerConfig);
        // Then ensure the dynamo cache won't have the pools
        for (const pool of SUPPORTED_POOLS) {
            const poolAddress = getMockedV3PoolProvider().getPoolAddress(pool.token0, pool.token1, pool.fee).poolAddress;
            log.info(`check if pool pool-${ChainId.GOERLI}-${poolAddress} block ${blockNumber} contains the cache`);
            const hasCachedPool = await dynamoCache.get(`pool-${ChainId.GOERLI}-${poolAddress}`, blockNumber);
            expect(hasCachedPool).to.not.equals;
        }
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vLWNhY2hpbmctcG9vbC1wcm92aWRlci50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vdGVzdC9tb2NoYS91bml0L2hhbmRsZXJzL3Bvb2xzL3Bvb2wtY2FjaGluZy92My9keW5hbW8tY2FjaGluZy1wb29sLXByb3ZpZGVyLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFBO0FBQ3BELE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLHNGQUFzRixDQUFBO0FBQ3BJLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGtEQUFrRCxDQUFBO0FBQzVHLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQTtBQUMxRSxPQUFPLEVBQUUsT0FBTyxFQUFTLE1BQU0sbUJBQW1CLENBQUE7QUFHbEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLE1BQU0sQ0FBQTtBQUM3QixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwyRUFBMkUsQ0FBQTtBQUMvRyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sNkJBQTZCLENBQUE7QUFFakQsUUFBUSxDQUFDLCtCQUErQixFQUFFLEtBQUssSUFBSSxFQUFFO0lBQ25ELFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0lBRTdCLEVBQUUsQ0FBQyxpREFBaUQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUMvRCxNQUFNLGVBQWUsR0FBRyxJQUFJLDZCQUE2QixDQUN2RCxPQUFPLENBQUMsTUFBTSxFQUNkLHVCQUF1QixFQUFFLEVBQ3pCLGdCQUFnQixDQUFDLFNBQVMsQ0FDM0IsQ0FBQTtRQUNELE1BQU0sV0FBVyxHQUFHLElBQUksbUJBQW1CLENBQUMsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQTtRQUV0RixNQUFNLGNB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aW1wb3J0IHsgc2V0dXBUYWJsZXMgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9kYlNldHVwJ1xuaW1wb3J0IHsgRHluYW1vREJDYWNoaW5nVjNQb29sUHJvdmlkZXIgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWIvaGFuZGxlcnMvcG9vbHMvcG9vbC1jYWNoaW5nL3YzL2R5bmFtby1jYWNoaW5nLXBvb2wtcHJvdmlkZXInXG5pbXBvcnQgeyBnZXRNb2NrZWRWM1Bvb2xQcm92aWRlciwgVEVTVF9ST1VURV9UQUJMRSB9IGZyb20gJy4uLy4uLy4uLy4uLy4uLy4uL3Rlc3QtdXRpbHMvbW9ja2VkLWRlcGVuZGVuY2llcydcbmltcG9ydCB7IFNVUFBPUlRFRF9QT09MUyB9IGZyb20gJy4uLy4uLy4uLy4uLy4uLy4uL3Rlc3QtdXRpbHMvbW9ja2VkLWRhdGEnXG5pbXBvcnQgeyBDaGFpbklkLCBUb2tlbiB9IGZyb20gJ0B1bmlzd2FwL3Nkay1jb3JlJ1xuaW1wb3J0IHsgRmVlQW1vdW50LCBQb29sIH0gZnJvbSAnQHVuaXN3YXAvdjMtc2RrJ1xuaW1wb3J0IHsgUHJvdmlkZXJDb25maWcgfSBmcm9tICdAdW5pc3dhcC9zbWFydC1vcmRlci1yb3V0ZXIvYnVpbGQvbWFpbi9wcm92aWRlcnMvcHJvdmlkZXInXG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tICdjaGFpJ1xuaW1wb3J0IHsgRHluYW1vQ2FjaGluZ1YzUG9vbCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYi9oYW5kbGVycy9wb29scy9wb29sLWNhY2hpbmcvdjMvY2FjaGUtZHluYW1vLXBvb2wnXG5pbXBvcnQgeyBsb2cgfSBmcm9tICdAdW5pc3dhcC9zbWFydC1vcmRlci1yb3V0ZXInXG5cbmRlc2NyaWJlKCdEeW5hbW9EQkNhY2hpbmdWM1Bvb2xQcm92aWRlcicsIGFzeW5jICgpID0+IHtcbiAgc2V0dXBUYWJsZXMoVEVTVF9ST1VURV9UQUJMRSlcblxuICBpdCgnY2FjaGVzIHBvb2xzIHByb3Blcmx5IHdpdGggYSBnaXZlbiBibG9jayBudW1iZXInLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgZHluYW1vUG9vbENhY2hlID0gbmV3IER5bmFtb0RCQ2FjaGluZ1YzUG9vbFByb3ZpZGVyKFxuICAgICAgQ2hhaW5JZC5HT0VSTEksXG4gICAgICBnZXRNb2NrZWRWM1Bvb2xQcm92aWRlcigpLFxuICAgICAgVEVTVF9ST1VURV9UQUJMRS5UYWJsZU5hbWVcbiAgICApXG4gICAgY29uc3QgZHluYW1vQ2FjaGUgPSBuZXcgRHluYW1vQ2FjaGluZ1YzUG9vbCh7IHRhYmxlTmFtZTogVEVTVF9ST1VURV9UQUJMRS5UYWJsZU5hbWUgfSlcblxuICAgIGNvbnN0IHByb3ZpZGVyQ29uZmlnOiBQcm92aWRlckNvbmZpZyA9IHsgYmxvY2tOdW1iZXI6IDExMSB9XG4gICAgY29uc3QgYmxvY2tOdW1iZXIgPSBhd2FpdCBwcm92aWRlckNvbmZpZy5ibG9ja051bWJlclxuXG4gICAgLy8gRmlyc3QgZW5zdXJlIHRoZSBkeW5hbW8gY2FjaGUgZG9lc24ndCBoYXZlIHRoZSBwb29scyB5ZXRcbiAgICBmb3IgKGNvbnN0IHBvb2wgb2YgU1VQUE9SVEVEX1BPT0xTKSB7XG4gICAgICBjb25zdCBwb29sQWRkcmVzcyA9IGdldE1vY2tlZFYzUG9vbFByb3ZpZGVyKCkuZ2V0UG9vbEFkZHJlc3MocG9vbC50b2tlbjAsIHBvb2wudG9rZW4xLCBwb29sLmZlZSkucG9vbEFkZHJlc3NcbiAgICAgIGNvbnN0IGhhc0NhY2hlZFBvb2wgPSBhd2FpdCBkeW5hbW9DYWNoZS5nZXQoYHBvb2wtJHtDaGFpbklkLkdPRVJMSX0tJHtwb29sQWRkcmVzc31gLCBibG9ja051bWJlcilcbiAgICAgIGV4cGVjdChoYXNDYWNoZWRQb29sKS50by5ub3QuZXhpc3RcbiAgICB9XG5cbiAgICBjb25zdCB0b2tlblBhaXJzOiBbVG9rZW4sIFRva2VuLCBGZWVBbW91bnRdW10gPSBTVVBQT1JURURfUE9PTFMubWFwKChwb29sOiBQb29sKSA9PiB7XG4gICAgICByZXR1cm4gW3Bvb2wudG9rZW4wLCBwb29sLnRva2VuMSwgcG9vbC5mZWVdXG4gICAgfSlcbiAgICBhd2FpdCBkeW5hbW9Qb29sQ2FjaGUuZ2V0UG9vbHModG9rZW5QYWlycywgcHJvdmlkZXJDb25maWcpXG5cbiAgICAvLyBUaGVuIGVuc3VyZSB0aGUgZHluYW1vIGNhY2hlIGhhcyB0aGUgcG9vbHMgeWV0XG4gICAgZm9yIChjb25zdCBwb29sIG9mIFNVUFBPUlRFRF9QT09MUykge1xuICAgICAgY29uc3QgcG9vbEFkZHJlc3MgPSBnZXRNb2NrZWRWM1Bvb2xQcm92aWRlcigpLmdldFBvb2xBZGRyZXNzKHBvb2wudG9rZW4wLCBwb29sLnRva2VuMSwgcG9vbC5mZWUpLnBvb2xBZGRyZXNzXG4gICAgICBjb25zdCBoYXNDYWNoZWRQb29sID0gYXdhaXQgZHluYW1vQ2FjaGUuZ2V0KGBwb29sLSR7Q2hhaW5JZC5HT0VSTEl9LSR7cG9vbEFkZHJlc3N9YCwgYmxvY2tOdW1iZXIpXG4gICAgICBleHBlY3QoaGFzQ2FjaGVkUG9vbCkudG8uZXhpc3RcblxuICAgICAgZXhwZWN0KGhhc0NhY2hlZFBvb2w/LnRva2VuMC5jaGFpbklkKS5lcXVhbHMocG9vbC50b2tlbjAuY2hhaW5JZClcbiAgICAgIGV4cGVjdChoYXNDYWNoZWRQb29sPy50b2tlbjAuZGVjaW1hbHMpLmVxdWFscyhwb29sLnRva2VuMC5kZWNpbWFscylcbiAgICAgIGV4cGVjdChoYXNDYWNoZWRQb29sPy50b2tlbjAuYWRkcmVzcykuZXF1YWxzKHBvb2wudG9rZW4wLmFkZHJlc3MpXG5cbiAgICAgIGV4cGVjdChoYXNDYWNoZWRQb29sPy50b2tlbjEuY2hhaW5JZCkuZXF1YWxzKHBvb2wudG9rZW4xLmNoYWluSWQpXG4gICAgICBleHBlY3QoaGFzQ2FjaGVkUG9vbD8udG9rZW4xLmRlY2ltYWxzKS5lcXVhbHMocG9vbC50b2tlbjEuZGVjaW1hbHMpXG4gICAgICBleHBlY3QoaGFzQ2FjaGVkUG9vbD8udG9rZW4xLmFkZHJlc3MpLmVxdWFscyhwb29sLnRva2VuMS5hZGRyZXNzKVxuXG4gICAgICBleHBlY3QoaGFzQ2FjaGVkUG9vbD8uZmVlKS5lcXVhbHMocG9vbC5mZWUpXG5cbiAgICAgIGV4cGVjdChoYXNDYWNoZWRQb29sPy5zcXJ0UmF0aW9YOTYudG9TdHJpbmcoKSkuZXF1YWxzKHBvb2wuc3FydFJhdGlvWDk2LnRvU3RyaW5nKCkpXG5cbiAgICAgIGV4cGVjdChoYXNDYWNoZWRQb29sPy5saXF1aWRpdHkudG9TdHJpbmcoKSkuZXF1YWxzKHBvb2wubGlxdWlkaXR5LnRvU3RyaW5nKCkpXG5cbiAgICAgIGV4cGVjdChoYXNDYWNoZWRQb29sPy50aWNrQ3VycmVudCkuZXF1YWxzKHBvb2wudGlja0N1cnJlbnQpXG4gICAgfVxuICB9KVxuXG4gIGl0KCdjYWNoZXMgZG8gbm90IGNhY2hlIHdoZW4gbm8gYmxvY2sgbnVtYmVyJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGR5bmFtb1Bvb2xDYWNoZSA9IG5ldyBEeW5hbW9EQkNhY2hpbmdWM1Bvb2xQcm92aWRlcihcbiAgICAgIENoYWluSWQuR09FUkxJLFxuICAgICAgZ2V0TW9ja2VkVjNQb29sUHJvdmlkZXIoKSxcbiAgICAgIFRFU1RfUk9VVEVfVEFCTEUuVGFibGVOYW1lXG4gICAgKVxuICAgIGNvbnN0IGR5bmFtb0NhY2hlID0gbmV3IER5bmFtb0NhY2hpbmdWM1Bvb2woeyB0YWJsZU5hbWU6IFRFU1RfUk9VVEVfVEFCTEUuVGFibGVOYW1lIH0pXG5cbiAgICBjb25zdCBwcm92aWRlckNvbmZpZzogUHJvdmlkZXJDb25maWcgPSB7IGJsb2NrTnVtYmVyOiB1bmRlZmluZWQgfVxuICAgIGNvbnN0IGJsb2NrTnVtYmVyID0gYXdhaXQgcHJvdmlkZXJDb25maWcuYmxvY2tOdW1iZXJcblxuICAgIC8vIEZpcnN0IGVuc3VyZSB0aGUgZHluYW1vIGNhY2hlIGRvZXNuJ3QgaGF2ZSB0aGUgcG9vbHMgeWV0XG4gICAgZm9yIChjb25zdCBwb29sIG9mIFNVUFBPUlRFRF9QT09MUykge1xuICAgICAgY29uc3QgcG9vbEFkZHJlc3MgPSBnZXRNb2NrZWRWM1Bvb2xQcm92aWRlcigpLmdldFBvb2xBZGRyZXNzKHBvb2wudG9rZW4wLCBwb29sLnRva2VuMSwgcG9vbC5mZWUpLnBvb2xBZGRyZXNzXG4gICAgICBsb2cuaW5mbyhgY2hlY2sgaWYgcG9vbCBwb29sLSR7Q2hhaW5JZC5HT0VSTEl9LSR7cG9vbEFkZHJlc3N9IGJsb2NrICR7YmxvY2tOdW1iZXJ9IGNvbnRhaW5zIHRoZSBjYWNoZWApXG4gICAgICBjb25zdCBoYXNDYWNoZWRQb29sID0gYXdhaXQgZHluYW1vQ2FjaGUuZ2V0KGBwb29sLSR7Q2hhaW5JZC5HT0VSTEl9LSR7cG9vbEFkZHJlc3N9YCwgYmxvY2tOdW1iZXIpXG4gICAgICBleHBlY3QoaGFzQ2FjaGVkUG9vbCkudG8ubm90LmV4aXN0XG4gICAgfVxuXG4gICAgY29uc3QgdG9rZW5QYWlyczogW1Rva2VuLCBUb2tlbiwgRmVlQW1vdW50XVtdID0gU1VQUE9SVEVEX1BPT0xTLm1hcCgocG9vbDogUG9vbCkgPT4ge1xuICAgICAgcmV0dXJuIFtwb29sLnRva2VuMCwgcG9vbC50b2tlbjEsIHBvb2wuZmVlXVxuICAgIH0pXG4gICAgYXdhaXQgZHluYW1vUG9vbENhY2hlLmdldFBvb2xzKHRva2VuUGFpcnMsIHByb3ZpZGVyQ29uZmlnKVxuXG4gICAgLy8gVGhlbiBlbnN1cmUgdGhlIGR5bmFtbyBjYWNoZSB3b24ndCBoYXZlIHRoZSBwb29sc1xuICAgIGZvciAoY29uc3QgcG9vbCBvZiBTVVBQT1JURURfUE9PTFMpIHtcbiAgICAgIGNvbnN0IHBvb2xBZGRyZXNzID0gZ2V0TW9ja2VkVjNQb29sUHJvdmlkZXIoKS5nZXRQb29sQWRkcmVzcyhwb29sLnRva2VuMCwgcG9vbC50b2tlbjEsIHBvb2wuZmVlKS5wb29sQWRkcmVzc1xuICAgICAgbG9nLmluZm8oYGNoZWNrIGlmIHBvb2wgcG9vbC0ke0NoYWluSWQuR09FUkxJfS0ke3Bvb2xBZGRyZXNzfSBibG9jayAke2Jsb2NrTnVtYmVyfSBjb250YWlucyB0aGUgY2FjaGVgKVxuICAgICAgY29uc3QgaGFzQ2FjaGVkUG9vbCA9IGF3YWl0IGR5bmFtb0NhY2hlLmdldChgcG9vbC0ke0NoYWluSWQuR09FUkxJfS0ke3Bvb2xBZGRyZXNzfWAsIGJsb2NrTnVtYmVyKVxuICAgICAgZXhwZWN0KGhhc0NhY2hlZFBvb2wpLnRvLm5vdC5lcXVhbHNcbiAgICB9XG4gIH0pXG59KVxuIl19