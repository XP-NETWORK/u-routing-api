import chai, { expect } from 'chai';
import chaiAsPromised from 'chai-as-promised';
import 'reflect-metadata';
import { setupTables } from '../../../../dbSetup';
import { DynamoRouteCachingProvider } from '../../../../../../lib/handlers/router-entities/route-caching';
import { Protocol } from '@uniswap/router-sdk';
import { ChainId, CurrencyAmount, TradeType } from '@uniswap/sdk-core';
import JSBI from 'jsbi';
import { FeeAmount, Pool } from '@uniswap/v3-sdk';
import { WNATIVE_ON } from '../../../../../utils/tokens';
import { CacheMode, CachedRoute, CachedRoutes, UNI_MAINNET, USDC_MAINNET, V3Route } from '@uniswap/smart-order-router';
import { DynamoDBTableProps } from '../../../../../../bin/stacks/routing-database-stack';
chai.use(chaiAsPromised);
const TEST_ROUTE_CACHING_TABLE = {
    TableName: 'RouteCachingDB',
    KeySchema: [
        {
            AttributeName: 'pairTradeTypeChainId',
            KeyType: 'HASH',
        },
        {
            AttributeName: 'protocolsBucketBlockNumber',
            KeyType: 'RANGE',
        },
    ],
    AttributeDefinitions: [
        {
            AttributeName: 'pairTradeTypeChainId',
            AttributeType: 'S',
        },
        {
            AttributeName: 'protocolsBucketBlockNumber',
            AttributeType: 'S',
        },
    ],
    ProvisionedThroughput: {
        ReadCapacityUnits: 1,
        WriteCapacityUnits: 1,
    },
};
const TEST_ROUTE_DB_TABLE = {
    TableName: DynamoDBTableProps.RoutesDbTable.Name,
    KeySchema: [
        {
            AttributeName: 'pairTradeTypeChainId',
            KeyType: 'HASH',
        },
        {
            AttributeName: 'routeId',
            KeyType: 'RANGE',
        },
    ],
    AttributeDefinitions: [
        {
            AttributeName: 'pairTradeTypeChainId',
            AttributeType: 'S',
        },
        {
            AttributeName: 'routeId',
            AttributeType: 'N',
        },
    ],
    ProvisionedThroughput: {
        ReadCapacityUnits: 1,
        WriteCapacityUnits: 1,
    },
};
const WETH = WNATIVE_ON(ChainId.MAINNET);
const TEST_WETH_USDC_POOL = new Pool(WETH, USDC_MAINNET, FeeAmount.HIGH, 
/* sqrtRatio */ '2437312313659959819381354528', 
/* liquidity */ '10272714736694327408', 
/* tickCurrent */ -69633);
const TEST_UNI_USDC_POOL = new Pool(UNI_MAINNET, USDC_MAINNET, FeeAmount.HIGH, 
/* sqrtRatio */ '2437312313659959819381354528', 
/* liquidity */ '10272714736694327408', 
/* tickCurrent */ -69633);
const TEST_WETH_USDC_V3_ROUTE = new V3Route([TEST_WETH_USDC_POOL], WETH, USDC_MAINNET);
const TEST_UNI_USDC_ROUTE = new V3Route([TEST_UNI_USDC_POOL], UNI_MAINNET, USDC_MAINNET);
const TEST_CACHED_ROUTE = new CachedRoute({ route: TEST_WETH_USDC_V3_ROUTE, percent: 100 });
const TEST_CACHED_ROUTES = new CachedRoutes({
    routes: [TEST_CACHED_ROUTE],
    chainId: TEST_CACHED_ROUTE.route.chainId,
    tokenIn: WETH,
    tokenOut: USDC_MAINNET,
    protocolsCovered: [TEST_CACHED_ROUTE.protocol],
    blockNumber: 0,
    tradeType: TradeType.EXACT_INPUT,
    originalAmount: '1',
    blocksToLive: 5,
});
const TEST_UNCACHED_ROUTE = new CachedRoute({ route: TEST_UNI_USDC_ROUTE, percent: 100 });
const TEST_UNCACHED_ROUTES = new CachedRoutes({
    routes: [TEST_UNCACHED_ROUTE],
    chainId: TEST_UNCACHED_ROUTE.route.chainId,
    tokenIn: UNI_MAINNET,
    tokenOut: USDC_MAINNET,
    protocolsCovered: [TEST_UNCACHED_ROUTE.protocol],
    blockNumber: 0,
    tradeType: TradeType.EXACT_INPUT,
    originalAmount: '1',
    blocksToLive: 5,
});
describe('DynamoRouteCachingProvider', async () => {
    setupTables(TEST_ROUTE_CACHING_TABLE, TEST_ROUTE_DB_TABLE);
    const dynamoRouteCache = new DynamoRouteCachingProvider({
        routesTableName: DynamoDBTableProps.RoutesDbTable.Name,
        routesCachingRequestFlagTableName: DynamoDBTableProps.RoutesDbCachingRequestFlagTable.Name,
        cachingQuoteLambdaName: 'test',
    });
    it('Caches routes properly for a token pair that has its cache configured to Livemode', async () => {
        const currencyAmount = CurrencyAmount.fromRawAmount(WETH, JSBI.BigInt(1 * 10 ** WETH.decimals));
        const cacheMode = await dynamoRouteCache.getCacheMode(ChainId.MAINNET, currencyAmount, USDC_MAINNET, TradeType.EXACT_INPUT, [Protocol.V3]);
        expect(cacheMode).to.equal(CacheMode.Livemode);
        const insertedIntoCache = await dynamoRouteCache.setCachedRoute(TEST_CACHED_ROUTES, currencyAmount);
        expect(insertedIntoCache).to.be.true;
        const cacheModeFromCachedRoutes = await dynamoRouteCache.getCacheModeFromCachedRoutes(TEST_CACHED_ROUTES, currencyAmount);
        expect(cacheModeFromCachedRoutes).to.equal(CacheMode.Livemode);
        // Fetches route successfully from cache when it has been cached.
        const route = await dynamoRouteCache.getCachedRoute(ChainId.MAINNET, currencyAmount, USDC_MAINNET, TradeType.EXACT_INPUT, [Protocol.V3], TEST_CACHED_ROUTES.blockNumber);
        expect(route).to.not.be.undefined;
    });
    it('Still uses RoutesDB Table for the default configuration', async () => {
        const currencyAmount = CurrencyAmount.fromRawAmount(UNI_MAINNET, JSBI.BigInt(1 * 10 ** UNI_MAINNET.decimals));
        const cacheMode = await dynamoRouteCache.getCacheMode(ChainId.MAINNET, currencyAmount, USDC_MAINNET, TradeType.EXACT_INPUT, [Protocol.V3]);
        expect(cacheMode).to.equal(CacheMode.Livemode);
        const insertedIntoCache = await dynamoRouteCache.setCachedRoute(TEST_UNCACHED_ROUTES, currencyAmount);
        expect(insertedIntoCache).to.be.true;
        const cacheModeFromCachedRoutes = await dynamoRouteCache.getCacheModeFromCachedRoutes(TEST_UNCACHED_ROUTES, currencyAmount);
        expect(cacheModeFromCachedRoutes).to.equal(CacheMode.Livemode);
        // Fetches nothing from the cache since cache is in Darkmode.
        const route = await dynamoRouteCache.getCachedRoute(ChainId.MAINNET, currencyAmount, USDC_MAINNET, TradeType.EXACT_INPUT, [Protocol.V3], TEST_CACHED_ROUTES.blockNumber);
        expect(route).to.not.be.undefined;
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vLXJvdXRlLWNhY2hpbmctcHJvdmlkZXIudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Rlc3QvbW9jaGEvdW5pdC9oYW5kbGVycy9yb3V0ZXItZW50aXRpZXMvcm91dGUtY2FjaGluZy9keW5hbW8tcm91dGUtY2FjaGluZy1wcm92aWRlci50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sTUFBTSxDQUFBO0FBQ25DLE9BQU8sY0FBYyxNQUFNLGtCQUFrQixDQUFBO0FBQzdDLE9BQU8sa0JBQWtCLENBQUE7QUFDekIsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFBO0FBQ2pELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDhEQUE4RCxDQUFBO0FBQ3pHLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQTtBQUM5QyxPQUFPLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQTtBQUN0RSxPQUFPLElBQUksTUFBTSxNQUFNLENBQUE7QUFDdkIsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQTtBQUNqRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sNkJBQTZCLENBQUE7QUFDeEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLE1BQU0sNkJBQTZCLENBQUE7QUFDdEgsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0scURBQXFELENBQUE7QUFFeEYsSUFBSSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQTtBQUV4QixNQUFNLHdCQUF3QixHQUFHO0lBQy9CLFNBQVMsRUFBRSxnQkFBZ0I7SUFDM0IsU0FBUyxFQUFFO1FBQ1Q7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UyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUE7UUFFOUMsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsRUFBRSxjQUFjLENBQUMsQ0FBQTtRQUNyRyxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQTtRQUVwQyxNQUFNLHlCQUF5QixHQUFHLE1BQU0sZ0JBQWdCLENBQUMsNEJBQTRCLENBQ25GLG9CQUFvQixFQUNwQixjQUFjLENBQ2YsQ0FBQTtRQUNELE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBRTlELDZEQUE2RDtRQUM3RCxNQUFNLEtBQUssR0FBRyxNQUFNLGdCQUFnQixDQUFDLGNBQWMsQ0FDakQsT0FBTyxDQUFDLE9BQU8sRUFDZixjQUFjLEVBQ2QsWUFBWSxFQUNaLFNBQVMsQ0FBQyxXQUFXLEVBQ3JCLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUNiLGtCQUFrQixDQUFDLFdBQVcsQ0FDL0IsQ0FBQTtRQUNELE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUE7SUFDbkMsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGFpLCB7IGV4cGVjdCB9IGZyb20gJ2NoYWknXG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCdcbmltcG9ydCAncmVmbGVjdC1tZXRhZGF0YSdcbmltcG9ydCB7IHNldHVwVGFibGVzIH0gZnJvbSAnLi4vLi4vLi4vLi4vZGJTZXR1cCdcbmltcG9ydCB7IER5bmFtb1JvdXRlQ2FjaGluZ1Byb3ZpZGVyIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vLi4vbGliL2hhbmRsZXJzL3JvdXRlci1lbnRpdGllcy9yb3V0ZS1jYWNoaW5nJ1xuaW1wb3J0IHsgUHJvdG9jb2wgfSBmcm9tICdAdW5pc3dhcC9yb3V0ZXItc2RrJ1xuaW1wb3J0IHsgQ2hhaW5JZCwgQ3VycmVuY3lBbW91bnQsIFRyYWRlVHlwZSB9IGZyb20gJ0B1bmlzd2FwL3Nkay1jb3JlJ1xuaW1wb3J0IEpTQkkgZnJvbSAnanNiaSdcbmltcG9ydCB7IEZlZUFtb3VudCwgUG9vbCB9IGZyb20gJ0B1bmlzd2FwL3YzLXNkaydcbmltcG9ydCB7IFdOQVRJVkVfT04gfSBmcm9tICcuLi8uLi8uLi8uLi8uLi91dGlscy90b2tlbnMnXG5pbXBvcnQgeyBDYWNoZU1vZGUsIENhY2hlZFJvdXRlLCBDYWNoZWRSb3V0ZXMsIFVOSV9NQUlOTkVULCBVU0RDX01BSU5ORVQsIFYzUm91dGUgfSBmcm9tICdAdW5pc3dhcC9zbWFydC1vcmRlci1yb3V0ZXInXG5pbXBvcnQgeyBEeW5hbW9EQlRhYmxlUHJvcHMgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi8uLi9iaW4vc3RhY2tzL3JvdXRpbmctZGF0YWJhc2Utc3RhY2snXG5cbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKVxuXG5jb25zdCBURVNUX1JPVVRFX0NBQ0hJTkdfVEFCTEUgPSB7XG4gIFRhYmxlTmFtZTogJ1JvdXRlQ2FjaGluZ0RCJyxcbiAgS2V5U2NoZW1hOiBbXG4gICAge1xuICAgICAgQXR0cmlidXRlTmFtZTogJ3BhaXJUcmFkZVR5cGVDaGFpbklkJyxcbiAgICAgIEtleVR5cGU6ICdIQVNIJyxcbiAgICB9LFxuICAgIHtcbiAgICAgIEF0dHJpYnV0ZU5hbWU6ICdwcm90b2NvbHNCdWNrZXRCbG9ja051bWJlcicsXG4gICAgICBLZXlUeXBlOiAnUkFOR0UnLFxuICAgIH0sXG4gIF0sXG4gIEF0dHJpYnV0ZURlZmluaXRpb25zOiBbXG4gICAge1xuICAgICAgQXR0cmlidXRlTmFtZTogJ3BhaXJUcmFkZVR5cGVDaGFpbklkJyxcbiAgICAgIEF0dHJpYnV0ZVR5cGU6ICdTJyxcbiAgICB9LFxuICAgIHtcbiAgICAgIEF0dHJpYnV0ZU5hbWU6ICdwcm90b2NvbHNCdWNrZXRCbG9ja051bWJlcicsXG4gICAgICBBdHRyaWJ1dGVUeXBlOiAnUycsXG4gICAgfSxcbiAgXSxcbiAgUHJvdmlzaW9uZWRUaHJvdWdocHV0OiB7XG4gICAgUmVhZENhcGFjaXR5VW5pdHM6IDEsXG4gICAgV3JpdGVDYXBhY2l0eVVuaXRzOiAxLFxuICB9LFxufVxuXG5jb25zdCBURVNUX1JPVVRFX0RCX1RBQkxFID0ge1xuICBUYWJsZU5hbWU6IER5bmFtb0RCVGFibGVQcm9wcy5Sb3V0ZXNEYlRhYmxlLk5hbWUsXG4gIEtleVNjaGVtYTogW1xuICAgIHtcbiAgICAgIEF0dHJpYnV0ZU5hbWU6ICdwYWlyVHJhZGVUeXBlQ2hhaW5JZCcsXG4gICAgICBLZXlUeXBlOiAnSEFTSCcsXG4gICAgfSxcbiAgICB7XG4gICAgICBBdHRyaWJ1dGVOYW1lOiAncm91dGVJZCcsXG4gICAgICBLZXlUeXBlOiAnUkFOR0UnLFxuICAgIH0sXG4gIF0sXG4gIEF0dHJpYnV0ZURlZmluaXRpb25zOiBbXG4gICAge1xuICAgICAgQXR0cmlidXRlTmFtZTogJ3BhaXJUcmFkZVR5cGVDaGFpbklkJyxcbiAgICAgIEF0dHJpYnV0ZVR5cGU6ICdTJyxcbiAgICB9LFxuICAgIHtcbiAgICAgIEF0dHJpYnV0ZU5hbWU6ICdyb3V0ZUlkJyxcbiAgICAgIEF0dHJpYnV0ZVR5cGU6ICdOJyxcbiAgICB9LFxuICBdLFxuICBQcm92aXNpb25lZFRocm91Z2hwdXQ6IHtcbiAgICBSZWFkQ2FwYWNpdHlVbml0czogMSxcbiAgICBXcml0ZUNhcGFjaXR5VW5pdHM6IDEsXG4gIH0sXG59XG5cbmNvbnN0IFdFVEggPSBXTkFUSVZFX09OKENoYWluSWQuTUFJTk5FVClcblxuY29uc3QgVEVTVF9XRVRIX1VTRENfUE9PTCA9IG5ldyBQb29sKFxuICBXRVRILFxuICBVU0RDX01BSU5ORVQsXG4gIEZlZUFtb3VudC5ISUdILFxuICAvKiBzcXJ0UmF0aW8gKi8gJzI0MzczMTIzMTM2NTk5NTk4MTkzODEzNTQ1MjgnLFxuICAvKiBsaXF1aWRpdHkgKi8gJzEwMjcyNzE0NzM2Njk0MzI3NDA4JyxcbiAgLyogdGlja0N1cnJlbnQgKi8gLTY5NjMzXG4pXG5cbmNvbnN0IFRFU1RfVU5JX1VTRENfUE9PTCA9IG5ldyBQb29sKFxuICBVTklfTUFJTk5FVCxcbiAgVVNEQ19NQUlOTkVULFxuICBGZWVBbW91bnQuSElHSCxcbiAgLyogc3FydFJhdGlvICovICcyNDM3MzEyMzEzNjU5OTU5ODE5MzgxMzU0NTI4JyxcbiAgLyogbGlxdWlkaXR5ICovICcxMDI3MjcxNDczNjY5NDMyNzQwOCcsXG4gIC8qIHRpY2tDdXJyZW50ICovIC02OTYzM1xuKVxuXG5jb25zdCBURVNUX1dFVEhfVVNEQ19WM19ST1VURSA9IG5ldyBWM1JvdXRlKFtURVNUX1dFVEhfVVNEQ19QT09MXSwgV0VUSCwgVVNEQ19NQUlOTkVUKVxuY29uc3QgVEVTVF9VTklfVVNEQ19ST1VURSA9IG5ldyBWM1JvdXRlKFtURVNUX1VOSV9VU0RDX1BPT0xdLCBVTklfTUFJTk5FVCwgVVNEQ19NQUlOTkVUKVxuXG5jb25zdCBURVNUX0NBQ0hFRF9ST1VURSA9IG5ldyBDYWNoZWRSb3V0ZSh7IHJvdXRlOiBURVNUX1dFVEhfVVNEQ19WM19ST1VURSwgcGVyY2VudDogMTAwIH0pXG5jb25zdCBURVNUX0NBQ0hFRF9ST1VURVMgPSBuZXcgQ2FjaGVkUm91dGVzKHtcbiAgcm91dGVzOiBbVEVTVF9DQUNIRURfUk9VVEVdLFxuICBjaGFpbklkOiBURVNUX0NBQ0hFRF9ST1VURS5yb3V0ZS5jaGFpbklkLFxuICB0b2tlbkluOiBXRVRILFxuICB0b2tlbk91dDogVVNEQ19NQUlOTkVULFxuICBwcm90b2NvbHNDb3ZlcmVkOiBbVEVTVF9DQUNIRURfUk9VVEUucHJvdG9jb2xdLFxuICBibG9ja051bWJlcjogMCxcbiAgdHJhZGVUeXBlOiBUcmFkZVR5cGUuRVhBQ1RfSU5QVVQsXG4gIG9yaWdpbmFsQW1vdW50OiAnMScsXG4gIGJsb2Nrc1RvTGl2ZTogNSxcbn0pXG5cbmNvbnN0IFRFU1RfVU5DQUNIRURfUk9VVEUgPSBuZXcgQ2FjaGVkUm91dGUoeyByb3V0ZTogVEVTVF9VTklfVVNEQ19ST1VURSwgcGVyY2VudDogMTAwIH0pXG5jb25zdCBURVNUX1VOQ0FDSEVEX1JPVVRFUyA9IG5ldyBDYWNoZWRSb3V0ZXMoe1xuICByb3V0ZXM6IFtURVNUX1VOQ0FDSEVEX1JPVVRFXSxcbiAgY2hhaW5JZDogVEVTVF9VTkNBQ0hFRF9ST1VURS5yb3V0ZS5jaGFpbklkLFxuICB0b2tlbkluOiBVTklfTUFJTk5FVCxcbiAgdG9rZW5PdXQ6IFVTRENfTUFJTk5FVCxcbiAgcHJvdG9jb2xzQ292ZXJlZDogW1RFU1RfVU5DQUNIRURfUk9VVEUucHJvdG9jb2xdLFxuICBibG9ja051bWJlcjogMCxcbiAgdHJhZGVUeXBlOiBUcmFkZVR5cGUuRVhBQ1RfSU5QVVQsXG4gIG9yaWdpbmFsQW1vdW50OiAnMScsXG4gIGJsb2Nrc1RvTGl2ZTogNSxcbn0pXG5cbmRlc2NyaWJlKCdEeW5hbW9Sb3V0ZUNhY2hpbmdQcm92aWRlcicsIGFzeW5jICgpID0+IHtcbiAgc2V0dXBUYWJsZXMoVEVTVF9ST1VURV9DQUNISU5HX1RBQkxFLCBURVNUX1JPVVRFX0RCX1RBQkxFKVxuICBjb25zdCBkeW5hbW9Sb3V0ZUNhY2hlID0gbmV3IER5bmFtb1JvdXRlQ2FjaGluZ1Byb3ZpZGVyKHtcbiAgICByb3V0ZXNUYWJsZU5hbWU6IER5bmFtb0RCVGFibGVQcm9wcy5Sb3V0ZXNEYlRhYmxlLk5hbWUsXG4gICAgcm91dGVzQ2FjaGluZ1JlcXVlc3RGbGFnVGFibGVOYW1lOiBEeW5hbW9EQlRhYmxlUHJvcHMuUm91dGVzRGJDYWNoaW5nUmVxdWVzdEZsYWdUYWJsZS5OYW1lLFxuICAgIGNhY2hpbmdRdW90ZUxhbWJkYU5hbWU6ICd0ZXN0JyxcbiAgfSlcblxuICBpdCgnQ2FjaGVzIHJvdXRlcyBwcm9wZXJseSBmb3IgYSB0b2tlbiBwYWlyIHRoYXQgaGFzIGl0cyBjYWNoZSBjb25maWd1cmVkIHRvIExpdmVtb2RlJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGN1cnJlbmN5QW1vdW50ID0gQ3VycmVuY3lBbW91bnQuZnJvbVJhd0Ftb3VudChXRVRILCBKU0JJLkJpZ0ludCgxICogMTAgKiogV0VUSC5kZWNpbWFscykpXG4gICAgY29uc3QgY2FjaGVNb2RlID0gYXdhaXQgZHluYW1vUm91dGVDYWNoZS5nZXRDYWNoZU1vZGUoXG4gICAgICBDaGFpbklkLk1BSU5ORVQsXG4gICAgICBjdXJyZW5jeUFtb3VudCxcbiAgICAgIFVTRENfTUFJTk5FVCxcbiAgICAgIFRyYWRlVHlwZS5FWEFDVF9JTlBVVCxcbiAgICAgIFtQcm90b2NvbC5WM11cbiAgICApXG4gICAgZXhwZWN0KGNhY2hlTW9kZSkudG8uZXF1YWwoQ2FjaGVNb2RlLkxpdmVtb2RlKVxuXG4gICAgY29uc3QgaW5zZXJ0ZWRJbnRvQ2FjaGUgPSBhd2FpdCBkeW5hbW9Sb3V0ZUNhY2hlLnNldENhY2hlZFJvdXRlKFRFU1RfQ0FDSEVEX1JPVVRFUywgY3VycmVuY3lBbW91bnQpXG4gICAgZXhwZWN0KGluc2VydGVkSW50b0NhY2hlKS50by5iZS50cnVlXG5cbiAgICBjb25zdCBjYWNoZU1vZGVGcm9tQ2FjaGVkUm91dGVzID0gYXdhaXQgZHluYW1vUm91dGVDYWNoZS5nZXRDYWNoZU1vZGVGcm9tQ2FjaGVkUm91dGVzKFxuICAgICAgVEVTVF9DQUNIRURfUk9VVEVTLFxuICAgICAgY3VycmVuY3lBbW91bnRcbiAgICApXG4gICAgZXhwZWN0KGNhY2hlTW9kZUZyb21DYWNoZWRSb3V0ZXMpLnRvLmVxdWFsKENhY2hlTW9kZS5MaXZlbW9kZSlcblxuICAgIC8vIEZldGNoZXMgcm91dGUgc3VjY2Vzc2Z1bGx5IGZyb20gY2FjaGUgd2hlbiBpdCBoYXMgYmVlbiBjYWNoZWQuXG4gICAgY29uc3Qgcm91dGUgPSBhd2FpdCBkeW5hbW9Sb3V0ZUNhY2hlLmdldENhY2hlZFJvdXRlKFxuICAgICAgQ2hhaW5JZC5NQUlOTkVULFxuICAgICAgY3VycmVuY3lBbW91bnQsXG4gICAgICBVU0RDX01BSU5ORVQsXG4gICAgICBUcmFkZVR5cGUuRVhBQ1RfSU5QVVQsXG4gICAgICBbUHJvdG9jb2wuVjNdLFxuICAgICAgVEVTVF9DQUNIRURfUk9VVEVTLmJsb2NrTnVtYmVyXG4gICAgKVxuICAgIGV4cGVjdChyb3V0ZSkudG8ubm90LmJlLnVuZGVmaW5lZFxuICB9KVxuXG4gIGl0KCdTdGlsbCB1c2VzIFJvdXRlc0RCIFRhYmxlIGZvciB0aGUgZGVmYXVsdCBjb25maWd1cmF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGN1cnJlbmN5QW1vdW50ID0gQ3VycmVuY3lBbW91bnQuZnJvbVJhd0Ftb3VudChVTklfTUFJTk5FVCwgSlNCSS5CaWdJbnQoMSAqIDEwICoqIFVOSV9NQUlOTkVULmRlY2ltYWxzKSlcbiAgICBjb25zdCBjYWNoZU1vZGUgPSBhd2FpdCBkeW5hbW9Sb3V0ZUNhY2hlLmdldENhY2hlTW9kZShcbiAgICAgIENoYWluSWQuTUFJTk5FVCxcbiAgICAgIGN1cnJlbmN5QW1vdW50LFxuICAgICAgVVNEQ19NQUlOTkVULFxuICAgICAgVHJhZGVUeXBlLkVYQUNUX0lOUFVULFxuICAgICAgW1Byb3RvY29sLlYzXVxuICAgIClcbiAgICBleHBlY3QoY2FjaGVNb2RlKS50by5lcXVhbChDYWNoZU1vZGUuTGl2ZW1vZGUpXG5cbiAgICBjb25zdCBpbnNlcnRlZEludG9DYWNoZSA9IGF3YWl0IGR5bmFtb1JvdXRlQ2FjaGUuc2V0Q2FjaGVkUm91dGUoVEVTVF9VTkNBQ0hFRF9ST1VURVMsIGN1cnJlbmN5QW1vdW50KVxuICAgIGV4cGVjdChpbnNlcnRlZEludG9DYWNoZSkudG8uYmUudHJ1ZVxuXG4gICAgY29uc3QgY2FjaGVNb2RlRnJvbUNhY2hlZFJvdXRlcyA9IGF3YWl0IGR5bmFtb1JvdXRlQ2FjaGUuZ2V0Q2FjaGVNb2RlRnJvbUNhY2hlZFJvdXRlcyhcbiAgICAgIFRFU1RfVU5DQUNIRURfUk9VVEVTLFxuICAgICAgY3VycmVuY3lBbW91bnRcbiAgICApXG4gICAgZXhwZWN0KGNhY2hlTW9kZUZyb21DYWNoZWRSb3V0ZXMpLnRvLmVxdWFsKENhY2hlTW9kZS5MaXZlbW9kZSlcblxuICAgIC8vIEZldGNoZXMgbm90aGluZyBmcm9tIHRoZSBjYWNoZSBzaW5jZSBjYWNoZSBpcyBpbiBEYXJrbW9kZS5cbiAgICBjb25zdCByb3V0ZSA9IGF3YWl0IGR5bmFtb1JvdXRlQ2FjaGUuZ2V0Q2FjaGVkUm91dGUoXG4gICAgICBDaGFpbklkLk1BSU5ORVQsXG4gICAgICBjdXJyZW5jeUFtb3VudCxcbiAgICAgIFVTRENfTUFJTk5FVCxcbiAgICAgIFRyYWRlVHlwZS5FWEFDVF9JTlBVVCxcbiAgICAgIFtQcm90b2NvbC5WM10sXG4gICAgICBURVNUX0NBQ0hFRF9ST1VURVMuYmxvY2tOdW1iZXJcbiAgICApXG4gICAgZXhwZWN0KHJvdXRlKS50by5ub3QuYmUudW5kZWZpbmVkXG4gIH0pXG59KVxuIl19